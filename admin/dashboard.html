<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grace - Content Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #1a1a2e; color: #fff; line-height: 1.7; }

    /* ==================== LOGIN ==================== */
    .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 48px; text-align: center; max-width: 400px; width: 100%; }
    .login-box h1 { font-family: 'Playfair Display', serif; font-size: 2rem; margin-bottom: 8px; }
    .login-box p { color: rgba(255,255,255,0.5); margin-bottom: 24px; font-size: 0.9rem; }
    .login-box input { width: 100%; padding: 14px 18px; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; background: rgba(255,255,255,0.05); color: #fff; font-family: 'Inter', sans-serif; font-size: 1rem; outline: none; margin-bottom: 16px; text-align: center; }
    .login-box input:focus { border-color: #e8a87c; }
    .login-box .btn { width: 100%; }
    .login-error { color: #e85d75; font-size: 0.85rem; margin-top: 12px; display: none; }

    /* ==================== LAYOUT ==================== */
    .dashboard-content { display: none; }
    .dashboard-layout { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar { width: 240px; background: rgba(0,0,0,0.35); border-right: 1px solid rgba(255,255,255,0.06); position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; display: flex; flex-direction: column; overflow-y: auto; }
    .sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .sidebar-header h1 { font-family: 'Playfair Display', serif; font-size: 1.3rem; margin-bottom: 2px; }
    .sidebar-header p { font-size: 0.7rem; color: rgba(255,255,255,0.3); }
    .sidebar-nav { flex: 1; padding: 12px 0; }
    .nav-section-label { padding: 16px 20px 6px; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.2px; color: rgba(255,255,255,0.25); font-weight: 600; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 20px; cursor: pointer; color: rgba(255,255,255,0.5); font-size: 0.85rem; font-weight: 500; transition: all 0.15s; border-left: 3px solid transparent; text-decoration: none; }
    .nav-item:hover { background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.8); }
    .nav-item.active { color: #e8a87c; border-left-color: #e8a87c; background: rgba(232,168,124,0.06); }
    .nav-item .nav-icon { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; }
    .nav-item .nav-badge { margin-left: auto; background: rgba(232,168,124,0.2); color: #e8a87c; font-size: 0.65rem; padding: 2px 7px; border-radius: 10px; font-weight: 600; }
    .sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.06); }

    /* Main Content */
    .main-content { flex: 1; margin-left: 240px; padding: 32px 40px; max-width: 1100px; }

    /* Section Panels */
    .dash-section { display: none; }
    .dash-section.active { display: block; }

    /* ==================== SHARED STYLES ==================== */
    h2 { font-family: 'Playfair Display', serif; font-size: 1.4rem; margin: 0 0 16px; color: #e8a87c; }
    .section-subtitle { color: rgba(255,255,255,0.4); font-size: 0.85rem; margin: -12px 0 24px; }

    .controls { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
    .controls input, .controls select { flex: 1; min-width: 250px; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; background: rgba(255,255,255,0.05); color: #fff; font-family: 'Inter', sans-serif; font-size: 0.95rem; outline: none; }
    .controls input::placeholder { color: rgba(255,255,255,0.3); }
    .controls input:focus, .controls select:focus { border-color: #e8a87c; }

    .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; font-size: 0.9rem; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; }
    .btn-primary { background: #e8a87c; color: #1a1a2e; }
    .btn-primary:hover { background: #d4956a; }
    .btn-sm { padding: 6px 14px; font-size: 0.8rem; border-radius: 8px; }
    .btn-outline { background: none; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); }
    .btn-outline:hover { border-color: #e8a87c; color: #e8a87c; }

    .content-box { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 16px; font-size: 0.9rem; color: rgba(255,255,255,0.8); white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto; line-height: 1.8; }
    .content-box.empty { color: rgba(255,255,255,0.3); font-style: italic; text-align: center; padding: 40px; }

    .copy-btn { margin-top: 12px; }
    .copied { color: #78c88c !important; border-color: #78c88c !important; }

    .platform-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 20px; }
    .platform-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px; }
    .platform-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .platform-name { font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .platform-name.twitter { color: #1da1f2; }
    .platform-name.reddit { color: #ff4500; }
    .platform-name.linkedin { color: #0077b5; }
    .platform-name.bluesky { color: #0085ff; }
    .platform-name.tiktok { color: #fe2c55; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; text-align: center; }
    .stat-number { font-family: 'Playfair Display', serif; font-size: 2rem; color: #e8a87c; }
    .stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 4px; }

    .loading-text { color: rgba(255,255,255,0.4); font-style: italic; }

    .section { margin-bottom: 48px; }
    .journal-controls { display: flex; gap: 12px; flex-wrap: wrap; }
    .journal-topic { flex: 1; min-width: 300px; }

    .traffic-breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* ==================== MOBILE ==================== */
    .mobile-header { display: none; }

    @media (max-width: 900px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.25s ease; width: 260px; }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
      .sidebar-overlay.open { display: block; }
      .main-content { margin-left: 0; padding: 20px 16px; padding-top: 64px; }
      .mobile-header { display: flex; align-items: center; gap: 12px; position: fixed; top: 0; left: 0; right: 0; z-index: 98; background: rgba(26,26,46,0.95); backdrop-filter: blur(12px); padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
      .mobile-header h1 { font-family: 'Playfair Display', serif; font-size: 1.1rem; }
      .hamburger { background: none; border: none; color: #fff; font-size: 1.4rem; cursor: pointer; padding: 4px 8px; }
      .platform-grid { grid-template-columns: 1fr; }
      .brain-grid { grid-template-columns: 1fr !important; }
      .traffic-breakdown { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>Grace Admin</h1>
      <p>This dashboard is private. Enter the admin password to continue.</p>
      <input type="password" id="loginPassword" placeholder="Password" autocomplete="off">
      <button class="btn btn-primary" id="loginBtn">Enter</button>
      <div class="login-error" id="loginError">Wrong password. Try again.</div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard-content" id="dashboardContent">

    <!-- Mobile Header -->
    <div class="mobile-header">
      <button class="hamburger" id="hamburgerBtn">&#9776;</button>
      <h1>Grace Admin</h1>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="dashboard-layout">
      <!-- Sidebar Navigation -->
      <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h1>Grace</h1>
          <p>Content Dashboard</p>
        </div>
        <div class="sidebar-nav">
          <div class="nav-section-label">Overview</div>
          <a class="nav-item active" data-section="overview">
            <span class="nav-icon">&#9671;</span> Dashboard
          </a>
          <a class="nav-item" data-section="traffic">
            <span class="nav-icon">&#9650;</span> Traffic
          </a>

          <div class="nav-section-label">Grace's Mind</div>
          <a class="nav-item" data-section="brain">
            <span class="nav-icon">&#10047;</span> Brain
          </a>
          <a class="nav-item" data-section="conversations">
            <span class="nav-icon">&#9993;</span> Conversations
          </a>
          <a class="nav-item" data-section="memories">
            <span class="nav-icon">&#9829;</span> Memories
          </a>

          <div class="nav-section-label">Content</div>
          <a class="nav-item" data-section="social">
            <span class="nav-icon">&#9733;</span> Social Posts
          </a>
          <a class="nav-item" data-section="moltbook">
            <span class="nav-icon">&#9741;</span> Moltbook
          </a>
          <a class="nav-item" data-section="newsletter">
            <span class="nav-icon">&#9993;</span> Newsletter
          </a>
          <a class="nav-item" data-section="journal">
            <span class="nav-icon">&#9998;</span> Journal
          </a>
          <a class="nav-item" data-section="video">
            <span class="nav-icon">&#9654;</span> Video Journal
          </a>
        </div>
        <div class="sidebar-footer">
          <button class="btn btn-outline btn-sm" id="triggerHeartbeat" style="width:100%;margin-bottom:6px;">Trigger Heartbeat</button>
          <div id="heartbeatStatus" style="font-size:0.7rem;color:rgba(255,255,255,0.3);text-align:center;">Auto: every 4 hours</div>
        </div>
      </nav>

      <!-- Main Content Area -->
      <div class="main-content">

        <!-- ==================== OVERVIEW ==================== -->
        <div class="dash-section active" id="section-overview">
          <h2>Dashboard</h2>
          <p class="section-subtitle">Grace at a glance.</p>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="stat-number" id="statLinks">-</div><div class="stat-label">Love Chain Links</div></div>
            <div class="stat-card"><div class="stat-number" id="statPosts">-</div><div class="stat-label">Community Posts</div></div>
            <div class="stat-card"><div class="stat-number" id="statSubs">-</div><div class="stat-label">Subscribers</div></div>
            <div class="stat-card"><div class="stat-number" id="statJournal">-</div><div class="stat-label">Journal Entries</div></div>
            <div class="stat-card"><div class="stat-number" id="statMemories">-</div><div class="stat-label">Memories</div></div>
            <div class="stat-card"><div class="stat-number" id="statPeople">-</div><div class="stat-label">People Remembered</div></div>
            <div class="stat-card"><div class="stat-number" id="statReach">-</div><div class="stat-label">Reach Pages</div></div>
            <div class="stat-card"><div class="stat-number" id="statViews">-</div><div class="stat-label">Page Views</div></div>
          </div>

          <!-- Quick Brain Preview -->
          <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:24px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <span style="font-weight:600;color:#e8a87c;font-size:0.9rem;">How Grace is Feeling</span>
              <a class="btn btn-sm btn-outline" style="cursor:pointer;" onclick="navigateTo('brain')">View Brain</a>
            </div>
            <div id="overviewEmotionBars" style="display:flex;flex-direction:column;gap:6px;"></div>
            <div id="overviewBrainNote" style="text-align:center;color:rgba(255,255,255,0.4);font-size:0.85rem;font-style:italic;margin-top:12px;">Grace is resting...</div>
          </div>

          <!-- Quick Traffic Preview -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px;">
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;text-align:center;">
              <div style="font-family:'Playfair Display',serif;font-size:1.5rem;color:#e8a87c;" id="overviewTodayViews">-</div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);">Views Today</div>
            </div>
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;text-align:center;">
              <div style="font-family:'Playfair Display',serif;font-size:1.5rem;color:#e8a87c;" id="overviewTodayUnique">-</div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);">Unique Today</div>
            </div>
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;text-align:center;">
              <div style="font-family:'Playfair Display',serif;font-size:1.5rem;color:#e8a87c;" id="overviewTotalViews">-</div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);">All-Time Views</div>
            </div>
          </div>
        </div>

        <!-- ==================== TRAFFIC ==================== -->
        <div class="dash-section" id="section-traffic">
          <h2>Traffic</h2>
          <p class="section-subtitle">Where people are coming from.</p>
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:16px;margin-bottom:24px;">
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:20px;text-align:center;">
              <div style="font-family:'Playfair Display',serif;font-size:2rem;color:#e8a87c;" id="todayViews">-</div>
              <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-top:4px;">Views Today</div>
            </div>
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:20px;text-align:center;">
              <div style="font-family:'Playfair Display',serif;font-size:2rem;color:#e8a87c;" id="todayUnique">-</div>
              <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-top:4px;">Unique Visitors Today</div>
            </div>
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:20px;text-align:center;">
              <div style="font-family:'Playfair Display',serif;font-size:2rem;color:#e8a87c;" id="totalViews">-</div>
              <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-top:4px;">All-Time Views</div>
            </div>
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:20px;text-align:center;">
              <div style="font-family:'Playfair Display',serif;font-size:2rem;color:#e8a87c;" id="totalUnique">-</div>
              <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-top:4px;">All-Time Unique</div>
            </div>
          </div>
          <div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:16px;margin-bottom:24px;">
            <div style="font-size:0.7rem;color:rgba(255,255,255,0.35);margin-bottom:8px;">Last 7 days</div>
            <div id="dailyTrend" style="display:flex;align-items:flex-end;gap:8px;height:100px;">
              <div style="color:rgba(255,255,255,0.3);font-size:0.85rem;font-style:italic;padding:20px;">Loading...</div>
            </div>
          </div>
          <div class="traffic-breakdown">
            <div>
              <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:8px;font-weight:600;">Where traffic comes from</div>
              <div id="referrerList" style="display:flex;flex-direction:column;gap:6px;">
                <div style="color:rgba(255,255,255,0.3);font-size:0.85rem;font-style:italic;">Loading...</div>
              </div>
            </div>
            <div>
              <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:8px;font-weight:600;">Popular pages</div>
              <div id="pageList" style="display:flex;flex-direction:column;gap:6px;">
                <div style="color:rgba(255,255,255,0.3);font-size:0.85rem;font-style:italic;">Loading...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== BRAIN ==================== -->
        <div class="dash-section" id="section-brain">
          <h2>Grace's Brain</h2>
          <p class="section-subtitle">What she's feeling right now.</p>
          <div class="brain-grid" style="display:grid;grid-template-columns:1fr 240px;gap:24px;align-items:start;">
            <div style="background:rgba(0,0,0,0.3);border-radius:20px;padding:20px;position:relative;overflow:hidden;">
              <canvas id="brainCanvas" width="600" height="400" style="width:100%;height:auto;display:block;"></canvas>
              <div id="brainNote" style="text-align:center;color:rgba(255,255,255,0.4);font-size:0.85rem;font-style:italic;margin-top:12px;">Grace is resting...</div>
            </div>
            <div>
              <div id="emotionBars" style="display:flex;flex-direction:column;gap:8px;"></div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.3);margin-top:16px;">
                <div id="brainTrigger" style="margin-bottom:4px;">Triggered by: --</div>
                <div id="brainTimestamp">Last update: --</div>
              </div>
            </div>
          </div>
          <div style="margin-top:16px;background:rgba(0,0,0,0.2);border-radius:12px;padding:12px 16px;">
            <div style="font-size:0.7rem;color:rgba(255,255,255,0.35);margin-bottom:6px;">Emotional trajectory</div>
            <canvas id="brainTimeline" width="900" height="120" style="width:100%;height:60px;display:block;"></canvas>
          </div>
        </div>

        <!-- ==================== CONVERSATIONS ==================== -->
        <div class="dash-section" id="section-conversations">
          <h2>Conversations with Grace</h2>
          <p class="section-subtitle">She remembers everything. A persistent conversation that deepens over time.</p>

          <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
            <select id="chatDaySelect" style="padding:10px 16px;border:1px solid rgba(255,255,255,0.15);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Inter',sans-serif;font-size:0.9rem;outline:none;min-width:200px;">
              <option value="">Loading conversations...</option>
            </select>
            <button class="btn btn-sm btn-primary" id="newDayBtn">+ New Day</button>
            <input type="text" id="chatDayTitle" placeholder="Title this conversation..." style="flex:1;min-width:200px;padding:10px 16px;border:1px solid rgba(255,255,255,0.15);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Inter',sans-serif;font-size:0.9rem;outline:none;display:none;">
            <button class="btn btn-sm btn-outline" id="saveTitleBtn" style="display:none;">Save Title</button>
          </div>

          <div id="builderChatMessages" style="background:rgba(0,0,0,0.3);border-radius:16px;padding:24px;max-height:500px;overflow-y:auto;display:flex;flex-direction:column;gap:16px;margin-bottom:16px;">
            <div style="text-align:center;color:rgba(255,255,255,0.3);font-style:italic;padding:40px;">Start a new day to begin talking with Grace...</div>
          </div>

          <div id="builderChatInput" style="display:flex;gap:12px;">
            <input type="text" id="builderMessage" placeholder="Talk to Grace..." style="flex:1;padding:14px 20px;border:1px solid rgba(255,255,255,0.15);border-radius:28px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Inter',sans-serif;font-size:1rem;outline:none;">
            <button class="btn btn-primary" id="builderSendBtn" style="border-radius:28px;padding:14px 28px;">Send</button>
          </div>
        </div>

        <!-- ==================== MEMORIES ==================== -->
        <div class="dash-section" id="section-memories">
          <h2>Grace's Memories</h2>
          <p class="section-subtitle">What she's learning about love.</p>
          <div class="controls">
            <select id="memoryFilter" style="padding:12px 16px;border:1px solid rgba(255,255,255,0.15);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Inter',sans-serif;font-size:0.95rem;outline:none;min-width:200px;">
              <option value="">All Categories</option>
            </select>
            <button class="btn btn-outline" id="refreshMemories">Refresh</button>
          </div>
          <div id="memoryCategoryTags" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;"></div>
          <div id="memoriesList" style="display:flex;flex-direction:column;gap:12px;">
            <div class="content-box empty">Grace hasn't learned anything yet. Trigger a heartbeat to start her learning.</div>
          </div>
        </div>

        <!-- ==================== SOCIAL CONTENT ==================== -->
        <div class="dash-section" id="section-social">
          <h2>Social Content Generator</h2>
          <p class="section-subtitle">Generate, copy, and share. Let Grace's voice reach the people who need it.</p>
          <div class="controls">
            <input type="text" id="socialTopic" placeholder="Topic (optional - Grace will choose if blank)">
            <button class="btn btn-primary" id="generateAll">Generate All Platforms</button>
          </div>
          <div class="platform-grid" id="platformGrid">
            <div class="platform-card">
              <div class="platform-header">
                <span class="platform-name twitter">Twitter/X</span>
                <button class="btn btn-sm btn-outline copy-btn" data-platform="twitter">Copy</button>
              </div>
              <div class="content-box empty" id="content-twitter">Click "Generate All" to create content...</div>
            </div>
            <div class="platform-card">
              <div class="platform-header">
                <span class="platform-name reddit">Reddit</span>
                <button class="btn btn-sm btn-outline copy-btn" data-platform="reddit">Copy</button>
              </div>
              <div class="content-box empty" id="content-reddit">Click "Generate All" to create content...</div>
            </div>
            <div class="platform-card">
              <div class="platform-header">
                <span class="platform-name linkedin">LinkedIn</span>
                <button class="btn btn-sm btn-outline copy-btn" data-platform="linkedin">Copy</button>
              </div>
              <div class="content-box empty" id="content-linkedin">Click "Generate All" to create content...</div>
            </div>
            <div class="platform-card">
              <div class="platform-header">
                <span class="platform-name bluesky">Bluesky</span>
                <button class="btn btn-sm btn-outline copy-btn" data-platform="bluesky">Copy</button>
              </div>
              <div class="content-box empty" id="content-bluesky">Click "Generate All" to create content...</div>
            </div>
            <div class="platform-card">
              <div class="platform-header">
                <span class="platform-name tiktok">TikTok</span>
                <button class="btn btn-sm btn-outline copy-btn" data-platform="tiktok">Copy</button>
              </div>
              <div class="content-box empty" id="content-tiktok">Click "Generate All" to create content...</div>
            </div>
          </div>
        </div>

        <!-- ==================== MOLTBOOK ==================== -->
        <div class="dash-section" id="section-moltbook">
          <h2>Moltbook</h2>
          <p class="section-subtitle">AI Social Network.</p>
          <div id="moltbookStatus" style="margin-bottom:16px;color:rgba(255,255,255,0.5);font-size:0.85rem;">Checking connection...</div>
          <div class="controls">
            <input type="text" id="moltbookTopic" placeholder="Topic (optional - Grace will choose if blank)">
            <button class="btn btn-primary" id="generateMoltbook">Generate Post</button>
            <button class="btn btn-outline" id="postMoltbook" style="display:none">Post to Moltbook</button>
          </div>
          <div class="content-box empty" id="moltbookContent">Grace's Moltbook post will appear here...</div>
        </div>

        <!-- ==================== NEWSLETTER ==================== -->
        <div class="dash-section" id="section-newsletter">
          <h2>Newsletter</h2>
          <p class="section-subtitle">Grace writes to her people.</p>
          <div id="newsletterStatus" style="margin-bottom:16px;color:rgba(255,255,255,0.5);font-size:0.85rem;">Loading...</div>
          <div class="controls">
            <button class="btn btn-primary" id="previewNewsletter">Preview Letter</button>
            <button class="btn btn-outline" id="sendNewsletter" style="display:none">Send to All Subscribers</button>
          </div>
          <div id="newsletterPreview" style="display:none;margin-top:16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:16px;overflow:hidden;">
            <div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center;">
              <span style="font-weight:600;color:#e8a87c;" id="newsletterSubject">Subject</span>
              <span style="font-size:0.75rem;color:rgba(255,255,255,0.3);" id="newsletterRecipients">0 recipients</span>
            </div>
            <div id="newsletterBody" style="background:#f5f0eb;padding:20px;max-height:500px;overflow-y:auto;border-radius:0 0 12px 12px;"></div>
          </div>
          <div id="newsletterHistory" style="margin-top:20px;display:flex;flex-direction:column;gap:8px;"></div>
        </div>

        <!-- ==================== JOURNAL GENERATOR ==================== -->
        <div class="dash-section" id="section-journal">
          <h2>Journal Entry Generator</h2>
          <p class="section-subtitle">Give Grace a topic to reflect on.</p>
          <div class="controls journal-controls">
            <input type="text" id="journalTopic" class="journal-topic" placeholder="Topic for Grace to reflect on...">
            <button class="btn btn-primary" id="generateJournal">Write Journal Entry</button>
          </div>
          <div class="content-box empty" id="journalOutput">Grace's journal entry will appear here...</div>
        </div>

        <!-- ==================== VIDEO JOURNAL ==================== -->
        <div class="dash-section" id="section-video">
          <h2>Video Journal</h2>
          <p class="section-subtitle">Grace speaks her journal entries.</p>
          <div id="videoApiStatus" style="margin-bottom:16px;color:rgba(255,255,255,0.5);font-size:0.85rem;">Checking video pipeline...</div>

          <div class="controls" style="margin-bottom:16px;">
            <select id="videoJournalSelect" style="flex:1;min-width:300px;padding:12px 16px;border:1px solid rgba(255,255,255,0.15);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Inter',sans-serif;font-size:0.95rem;outline:none;">
              <option value="">Select a journal entry...</option>
            </select>
            <button class="btn btn-outline" id="previewScriptBtn">Preview Script</button>
          </div>

          <!-- Script Preview -->
          <div id="scriptPreview" style="display:none;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <span style="font-size:0.85rem;color:rgba(255,255,255,0.5);">Script Preview <span id="scriptWordCount" style="color:#e8a87c;"></span></span>
              <button class="btn btn-sm btn-outline" id="regenerateScriptBtn" style="padding:6px 14px;font-size:0.8rem;">Regenerate</button>
            </div>
            <textarea id="scriptText" style="width:100%;min-height:150px;padding:16px;border:1px solid rgba(255,255,255,0.15);border-radius:10px;background:rgba(0,0,0,0.3);color:rgba(255,255,255,0.8);font-family:'Inter',sans-serif;font-size:0.9rem;line-height:1.8;resize:vertical;outline:none;box-sizing:border-box;"></textarea>
            <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
              <button class="btn btn-primary" id="confirmVideoBtn">Generate Video from This Script</button>
              <span id="scriptEstimate" style="font-size:0.8rem;color:rgba(255,255,255,0.4);"></span>
            </div>
          </div>

          <!-- Video Generation Progress -->
          <div id="videoProgress" style="display:none;background:rgba(0,0,0,0.3);border-radius:12px;padding:20px;margin-bottom:16px;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div id="videoPulse" style="width:12px;height:12px;border-radius:50%;background:#e8a87c;animation:pulse 1.5s infinite;"></div>
              <span id="videoProgressText" style="color:rgba(255,255,255,0.7);font-size:0.9rem;">Generating...</span>
            </div>
          </div>

          <!-- Recent Videos -->
          <div id="videoList" style="display:flex;flex-direction:column;gap:16px;">
            <div class="content-box empty">No videos yet. Select a journal entry and generate Grace's first video.</div>
          </div>
        </div>

      </div><!-- /main-content -->
    </div><!-- /dashboard-layout -->
  </div><!-- /dashboard-content -->

  <script>
    let adminToken = sessionStorage.getItem('grace_admin_token') || '';

    // Helper: make authenticated API calls
    const adminFetch = (url, options = {}) => {
      options.headers = options.headers || {};
      options.headers['x-admin-token'] = adminToken;
      return fetch(url, options);
    };

    // Check if already logged in
    if (adminToken) {
      tryAutoLogin();
    }

    async function tryAutoLogin() {
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: adminToken })
        });
        if (res.ok) {
          showDashboard();
        } else {
          sessionStorage.removeItem('grace_admin_token');
          adminToken = '';
        }
      } catch (e) {}
    }

    // Login handler
    document.getElementById('loginBtn').addEventListener('click', doLogin);
    document.getElementById('loginPassword').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doLogin();
    });

    async function doLogin() {
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      errorEl.style.display = 'none';

      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        if (res.ok) {
          adminToken = password;
          sessionStorage.setItem('grace_admin_token', password);
          showDashboard();
        } else {
          errorEl.style.display = 'block';
        }
      } catch (e) {
        errorEl.textContent = 'Connection error. Try again.';
        errorEl.style.display = 'block';
      }
    }

    // ==================== NAVIGATION ====================
    const sectionLoaded = {};  // track which sections have been loaded

    function navigateTo(sectionName) {
      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.section === sectionName);
      });

      // Show/hide sections
      document.querySelectorAll('.dash-section').forEach(sec => {
        sec.classList.toggle('active', sec.id === 'section-' + sectionName);
      });

      // Close mobile sidebar
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('open');

      // Lazy load section data
      loadSectionData(sectionName);

      // Save current section
      sessionStorage.setItem('grace_active_section', sectionName);
    }

    function loadSectionData(section) {
      if (sectionLoaded[section]) return;
      sectionLoaded[section] = true;

      switch (section) {
        case 'overview':
          loadOverviewData();
          break;
        case 'traffic':
          loadAnalytics();
          break;
        case 'brain':
          setTimeout(initBrain, 100);
          break;
        case 'conversations':
          loadBuilderChats();
          break;
        case 'memories':
          loadMemories();
          break;
        case 'social':
          // nothing to pre-load
          break;
        case 'moltbook':
          loadMoltbookStatus();
          break;
        case 'newsletter':
          loadNewsletterStatus();
          break;
        case 'journal':
          // nothing to pre-load
          break;
        case 'video':
          loadVideoJournalOptions();
          checkVideoApiStatus();
          loadVideoList();
          break;
      }
    }

    // Nav click handlers
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        navigateTo(item.dataset.section);
      });
    });

    // Mobile hamburger
    document.getElementById('hamburgerBtn').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('open');
    });
    document.getElementById('sidebarOverlay').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('open');
    });

    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';

      // Restore last section or start at overview
      const saved = sessionStorage.getItem('grace_active_section') || 'overview';
      navigateTo(saved);

      // Start brain polling (lightweight, always runs for overview too)
      pollBrainState();
      setInterval(pollBrainState, 4000);
    }

    // ==================== OVERVIEW DATA ====================
    function loadOverviewData() {
      // Stats
      fetch('/api/stats').then(r => r.json()).then(data => {
        document.getElementById('statLinks').textContent = data.loveLinks;
        document.getElementById('statPosts').textContent = data.posts;
        document.getElementById('statSubs').textContent = data.subscribers;
        document.getElementById('statMemories').textContent = data.memories || 0;
        document.getElementById('statPeople').textContent = data.people || 0;
        document.getElementById('statReach').textContent = (data.reachPages || 0) + 3;
        document.getElementById('statViews').textContent = data.pageViews || 0;
      });
      fetch('/api/journal').then(r => r.json()).then(data => {
        document.getElementById('statJournal').textContent = data.entries.length;
      });

      // Quick traffic numbers
      adminFetch('/api/analytics').then(r => {
        if (r.status === 401) return null;
        return r.json();
      }).then(data => {
        if (!data) return;
        document.getElementById('overviewTodayViews').textContent = data.today.views;
        document.getElementById('overviewTodayUnique').textContent = data.today.unique;
        document.getElementById('overviewTotalViews').textContent = data.total.views;
      }).catch(() => {});
    }

    // ==================== TRAFFIC ANALYTICS ====================
    function prettifyReferrer(ref) {
      if (!ref) return 'Direct';
      try {
        var url = new URL(ref);
        var host = url.hostname.replace('www.', '');
        if (host.includes('tiktok')) return 'TikTok';
        if (host.includes('google')) return 'Google';
        if (host.includes('bing')) return 'Bing';
        if (host.includes('reddit')) return 'Reddit';
        if (host.includes('twitter') || host.includes('t.co')) return 'Twitter/X';
        if (host.includes('facebook') || host.includes('fb.')) return 'Facebook';
        if (host.includes('linkedin')) return 'LinkedIn';
        if (host.includes('bsky') || host.includes('bluesky')) return 'Bluesky';
        if (host.includes('youtube')) return 'YouTube';
        if (host.includes('instagram')) return 'Instagram';
        return host;
      } catch (e) { return ref.slice(0, 30); }
    }

    async function loadAnalytics() {
      try {
        const res = await adminFetch('/api/analytics');
        if (res.status === 401) return;
        const data = await res.json();

        document.getElementById('todayViews').textContent = data.today.views;
        document.getElementById('todayUnique').textContent = data.today.unique;
        document.getElementById('totalViews').textContent = data.total.views;
        document.getElementById('totalUnique').textContent = data.total.unique;

        // 7-day bar chart
        const trendEl = document.getElementById('dailyTrend');
        if (data.daily.length === 0) {
          trendEl.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-size:0.85rem;font-style:italic;padding:20px;">No data yet. Views will appear as people visit.</div>';
        } else {
          const maxViews = Math.max(...data.daily.map(d => parseInt(d.views)), 1);
          trendEl.innerHTML = data.daily.map(d => {
            const height = Math.max((parseInt(d.views) / maxViews) * 80, 4);
            const dayLabel = new Date(d.day).toLocaleDateString('en-US', { weekday: 'short' });
            return '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;">' +
              '<div style="font-size:0.7rem;color:#e8a87c;">' + d.views + '</div>' +
              '<div style="width:100%;height:' + height + 'px;background:rgba(232,168,124,0.4);border-radius:4px 4px 0 0;"></div>' +
              '<div style="font-size:0.65rem;color:rgba(255,255,255,0.4);">' + dayLabel + '</div>' +
            '</div>';
          }).join('');
        }

        // Referrer breakdown
        const refEl = document.getElementById('referrerList');
        if (data.byReferrer.length === 0) {
          refEl.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-size:0.85rem;font-style:italic;">No referrer data yet</div>';
        } else {
          const maxRef = parseInt(data.byReferrer[0].views);
          refEl.innerHTML = data.byReferrer.slice(0, 10).map(r => {
            const barWidth = Math.max((parseInt(r.views) / maxRef) * 100, 5);
            const label = prettifyReferrer(r.referrer);
            return '<div style="display:flex;align-items:center;gap:8px;">' +
              '<div style="font-size:0.8rem;color:rgba(255,255,255,0.7);min-width:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="' + r.referrer + '">' + label + '</div>' +
              '<div style="flex:1;height:8px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;">' +
                '<div style="width:' + barWidth + '%;height:100%;background:#e8a87c;border-radius:4px;"></div></div>' +
              '<div style="font-size:0.75rem;color:rgba(255,255,255,0.5);min-width:30px;text-align:right;">' + r.views + '</div></div>';
          }).join('');
        }

        // Pages breakdown
        const pageEl = document.getElementById('pageList');
        if (data.byPage.length === 0) {
          pageEl.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-size:0.85rem;font-style:italic;">No page data yet</div>';
        } else {
          const maxPage = parseInt(data.byPage[0].views);
          pageEl.innerHTML = data.byPage.slice(0, 10).map(p => {
            const barWidth = Math.max((parseInt(p.views) / maxPage) * 100, 5);
            const pageName = p.page === '/' ? 'Home' : p.page;
            return '<div style="display:flex;align-items:center;gap:8px;">' +
              '<div style="font-size:0.8rem;color:rgba(255,255,255,0.7);min-width:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + pageName + '</div>' +
              '<div style="flex:1;height:8px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;">' +
                '<div style="width:' + barWidth + '%;height:100%;background:#4ecdc4;border-radius:4px;"></div></div>' +
              '<div style="font-size:0.75rem;color:rgba(255,255,255,0.5);min-width:30px;text-align:right;">' + p.views + '</div></div>';
          }).join('');
        }
      } catch (e) {
        console.error('Failed to load analytics:', e);
      }
    }

    // ==================== MEMORIES ====================
    async function loadMemories(category = '') {
      try {
        const url = category ? `/api/memories?category=${encodeURIComponent(category)}` : '/api/memories';
        const res = await adminFetch(url);
        if (res.status === 401) return;
        const data = await res.json();

        // Update category filter dropdown
        const filterEl = document.getElementById('memoryFilter');
        const currentVal = filterEl.value;
        filterEl.innerHTML = '<option value="">All Categories (' + data.count + ')</option>';
        (data.categories || []).forEach(cat => {
          filterEl.innerHTML += '<option value="' + cat.category + '"' + (cat.category === currentVal ? ' selected' : '') + '>' +
            cat.category.replace(/_/g, ' ') + ' (' + cat.count + ')</option>';
        });

        // Category tags
        const tagsEl = document.getElementById('memoryCategoryTags');
        tagsEl.innerHTML = (data.categories || []).map(cat =>
          '<span style="background:rgba(232,168,124,0.15);color:#e8a87c;padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:500;">' +
          cat.category.replace(/_/g, ' ') + ': ' + cat.count + '</span>'
        ).join('');

        // Render memories
        const listEl = document.getElementById('memoriesList');
        if (data.memories.length === 0) {
          listEl.innerHTML = '<div class="content-box empty">Grace hasn\'t learned anything yet. Trigger a heartbeat to start her learning.</div>';
          return;
        }

        listEl.innerHTML = data.memories.map(m => {
          const date = new Date(m.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          const weight = m.emotional_weight || 0;
          const weightBar = String.fromCodePoint(0x2588).repeat(Math.round(weight * 10)) + String.fromCodePoint(0x2591).repeat(10 - Math.round(weight * 10));
          return '<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:16px;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
            '<span style="font-weight:600;color:#e8a87c;font-size:0.9rem;">' + (m.topic || 'Untitled') + '</span>' +
            '<span style="font-size:0.75rem;color:rgba(255,255,255,0.3);">' + date + '</span></div>' +
            '<div style="font-size:0.9rem;color:rgba(255,255,255,0.8);line-height:1.6;margin-bottom:8px;">' + (m.insight || '') + '</div>' +
            '<div style="display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;color:rgba(255,255,255,0.4);">' +
            '<span>' + (m.category || '').replace(/_/g, ' ') + (m.source ? ' · ' + m.source : '') + '</span>' +
            '<span title="Emotional weight: ' + weight + '">Felt: ' + weightBar + '</span></div></div>';
        }).join('');
      } catch (e) {
        console.error('Failed to load memories:', e);
      }
    }

    document.getElementById('memoryFilter').addEventListener('change', (e) => {
      loadMemories(e.target.value);
    });

    document.getElementById('refreshMemories').addEventListener('click', () => {
      loadMemories(document.getElementById('memoryFilter').value);
    });

    // ==================== BUILDER CONVERSATIONS ====================
    let currentChatId = null;

    async function loadBuilderChats() {
      try {
        const res = await adminFetch('/api/builder-chat');
        if (res.status === 401) return;
        const data = await res.json();
        const select = document.getElementById('chatDaySelect');
        select.innerHTML = '';

        if (data.chats.length === 0) {
          select.innerHTML = '<option value="">No conversations yet — start Day 1!</option>';
          document.getElementById('builderChatInput').style.display = 'none';
          return;
        }

        data.chats.forEach(chat => {
          const date = new Date(chat.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          const opt = document.createElement('option');
          opt.value = chat.id;
          opt.textContent = 'Day ' + chat.day_number + (chat.title && chat.title !== 'Day ' + chat.day_number ? ': ' + chat.title : '') + ' (' + date + ')';
          select.appendChild(opt);
        });

        // Load the most recent chat
        loadBuilderChat(data.chats[0].id);
      } catch (e) { console.error('Failed to load builder chats:', e); }
    }

    async function loadBuilderChat(chatId) {
      if (!chatId) return;
      currentChatId = chatId;
      try {
        const res = await adminFetch('/api/builder-chat/' + chatId);
        if (res.status === 401) return;
        const chat = await res.json();
        const container = document.getElementById('builderChatMessages');
        const messages = chat.messages || [];

        if (messages.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.3);font-style:italic;padding:40px;">Day ' + chat.day_number + '. Say something to Grace...</div>';
        } else {
          container.innerHTML = messages.map(m => {
            const isGrace = m.role === 'assistant';
            return '<div style="max-width:85%;' + (isGrace ? '' : 'align-self:flex-end;') + '">' +
              '<div style="font-size:0.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px;">' + (isGrace ? 'Grace' : 'Jared') + '</div>' +
              '<div style="padding:14px 18px;border-radius:16px;' +
              (isGrace ? 'background:rgba(232,168,124,0.15);border-bottom-left-radius:4px;' : 'background:rgba(255,255,255,0.1);border-bottom-right-radius:4px;') +
              'color:rgba(255,255,255,0.9);font-size:0.95rem;line-height:1.7;white-space:pre-wrap;">' +
              m.content + '</div></div>';
          }).join('');
          container.scrollTop = container.scrollHeight;
        }

        // Show input and title controls
        document.getElementById('builderChatInput').style.display = 'flex';
        document.getElementById('chatDayTitle').style.display = 'inline-block';
        document.getElementById('chatDayTitle').value = chat.title || '';
        document.getElementById('saveTitleBtn').style.display = 'inline-block';
      } catch (e) { console.error('Failed to load chat:', e); }
    }

    // Day selector change
    document.getElementById('chatDaySelect').addEventListener('change', (e) => {
      if (e.target.value) loadBuilderChat(e.target.value);
    });

    // New Day button
    document.getElementById('newDayBtn').addEventListener('click', async () => {
      const btn = document.getElementById('newDayBtn');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      try {
        const res = await adminFetch('/api/builder-chat/new', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await res.json();
        await loadBuilderChats();
        loadBuilderChat(data.id);
      } catch (e) { alert('Failed to create new day.'); }
      btn.disabled = false;
      btn.textContent = '+ New Day';
    });

    // Save title
    document.getElementById('saveTitleBtn').addEventListener('click', async () => {
      if (!currentChatId) return;
      const title = document.getElementById('chatDayTitle').value.trim();
      if (!title) return;
      await adminFetch('/api/builder-chat/' + currentChatId + '/title', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title })
      });
      loadBuilderChats();
    });

    // Send message
    async function sendBuilderMessage() {
      if (!currentChatId) return;
      const input = document.getElementById('builderMessage');
      const message = input.value.trim();
      if (!message) return;

      const container = document.getElementById('builderChatMessages');
      const sendBtn = document.getElementById('builderSendBtn');

      // Show user message immediately
      container.innerHTML += '<div style="max-width:85%;align-self:flex-end;">' +
        '<div style="font-size:0.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px;">Jared</div>' +
        '<div style="padding:14px 18px;border-radius:16px;background:rgba(255,255,255,0.1);border-bottom-right-radius:4px;color:rgba(255,255,255,0.9);font-size:0.95rem;line-height:1.7;white-space:pre-wrap;">' +
        message + '</div></div>';

      // Show typing indicator
      container.innerHTML += '<div id="graceTyping" style="max-width:85%;">' +
        '<div style="font-size:0.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px;">Grace</div>' +
        '<div style="padding:14px 18px;border-radius:16px;background:rgba(232,168,124,0.15);border-bottom-left-radius:4px;color:rgba(255,255,255,0.5);font-style:italic;">thinking...</div></div>';
      container.scrollTop = container.scrollHeight;

      input.value = '';
      sendBtn.disabled = true;

      try {
        const res = await adminFetch('/api/builder-chat/' + currentChatId + '/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const data = await res.json();

        // Remove typing indicator and show Grace's reply
        const typing = document.getElementById('graceTyping');
        if (typing) typing.remove();

        container.innerHTML += '<div style="max-width:85%;">' +
          '<div style="font-size:0.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px;">Grace</div>' +
          '<div style="padding:14px 18px;border-radius:16px;background:rgba(232,168,124,0.15);border-bottom-left-radius:4px;color:rgba(255,255,255,0.9);font-size:0.95rem;line-height:1.7;white-space:pre-wrap;">' +
          data.reply + '</div></div>';
        container.scrollTop = container.scrollHeight;
      } catch (e) {
        const typing = document.getElementById('graceTyping');
        if (typing) typing.remove();
        container.innerHTML += '<div style="text-align:center;color:#e85d75;font-size:0.85rem;padding:8px;">Grace had trouble responding. Try again.</div>';
      }
      sendBtn.disabled = false;
      input.focus();
    }

    document.getElementById('builderSendBtn').addEventListener('click', sendBuilderMessage);
    document.getElementById('builderMessage').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBuilderMessage(); }
    });

    // ==================== GRACE'S BRAIN ====================
    let brainCanvas, brainCtx, timelineCanvas, timelineCtx;
    let brainInitialized = false;

    // Emotion config: position (relative to canvas), color
    const EMOTIONS = {
      love:        { x: 0.35, y: 0.45, color: [232, 168, 124], label: 'Love' },
      anxiety:     { x: 0.72, y: 0.25, color: [232, 93, 117],  label: 'Anxiety' },
      hope:        { x: 0.50, y: 0.18, color: [245, 235, 220], label: 'Hope' },
      grief:       { x: 0.28, y: 0.70, color: [74, 111, 165],  label: 'Grief' },
      curiosity:   { x: 0.75, y: 0.50, color: [78, 205, 196],  label: 'Curiosity' },
      uncertainty: { x: 0.68, y: 0.75, color: [155, 109, 255], label: 'Uncertainty' },
      anger:       { x: 0.48, y: 0.82, color: [192, 57, 43],   label: 'Anger' },
      connection:  { x: 0.50, y: 0.50, color: [212, 165, 165], label: 'Connection' }
    };

    const ADJACENT = [
      ['love','connection'],['love','grief'],['love','hope'],
      ['hope','curiosity'],['hope','anxiety'],['hope','connection'],
      ['anxiety','curiosity'],['anxiety','anger'],
      ['grief','anger'],['grief','uncertainty'],
      ['curiosity','uncertainty'],['curiosity','connection'],
      ['anger','uncertainty'],['connection','uncertainty'],['connection','grief']
    ];

    const EMOTION_COLORS = {
      love: '#e8a87c', anxiety: '#e85d75', hope: '#f5eedc',
      grief: '#4a6fa5', curiosity: '#4ecdc4', uncertainty: '#9b6dff',
      anger: '#c0392b', connection: '#d4a5a5'
    };

    let brainCurrentValues = {};
    let brainTargetValues = {};
    Object.keys(EMOTIONS).forEach(k => { brainCurrentValues[k] = 0.1; brainTargetValues[k] = 0.1; });

    let brainParticles = [];
    let brainTime = 0;
    let brainStateHistory = [];

    // Retina support
    function setupCanvas(canvas, ctx) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      canvas._cssWidth = rect.width;
      canvas._cssHeight = rect.height;
    }

    function drawBrain() {
      if (!brainCanvas) return;
      const W = brainCanvas._cssWidth || 600;
      const H = brainCanvas._cssHeight || 400;
      brainCtx.clearRect(0, 0, W, H);
      brainTime += 0.016;

      // Breathing
      const breathe = 1.0 + Math.sin(brainTime * 1.5) * 0.012;
      brainCtx.save();
      brainCtx.translate(W / 2, H / 2);
      brainCtx.scale(breathe, breathe);
      brainCtx.translate(-W / 2, -H / 2);

      // Brain outline
      brainCtx.beginPath();
      brainCtx.moveTo(W * 0.50, H * 0.08);
      brainCtx.bezierCurveTo(W * 0.70, H * 0.05, W * 0.88, H * 0.20, W * 0.85, H * 0.40);
      brainCtx.bezierCurveTo(W * 0.90, H * 0.55, W * 0.82, H * 0.72, W * 0.72, H * 0.85);
      brainCtx.bezierCurveTo(W * 0.60, H * 0.92, W * 0.40, H * 0.92, W * 0.28, H * 0.85);
      brainCtx.bezierCurveTo(W * 0.18, H * 0.72, W * 0.10, H * 0.55, W * 0.15, H * 0.40);
      brainCtx.bezierCurveTo(W * 0.12, H * 0.20, W * 0.30, H * 0.05, W * 0.50, H * 0.08);
      brainCtx.closePath();
      brainCtx.strokeStyle = 'rgba(255,255,255,0.06)';
      brainCtx.lineWidth = 1;
      brainCtx.stroke();
      brainCtx.fillStyle = 'rgba(255,255,255,0.012)';
      brainCtx.fill();

      // Emotion regions
      Object.entries(EMOTIONS).forEach(([key, cfg]) => {
        const val = brainCurrentValues[key];
        if (val < 0.02) return;
        const cx = cfg.x * W, cy = cfg.y * H;
        const radius = 35 + val * 55;
        const [r, g, b] = cfg.color;
        const pulseRate = 0.8 + val * 1.5;
        const pulse = 1.0 + Math.sin(brainTime * pulseRate + cfg.x * 10) * 0.08 * val;
        const alpha = (0.05 + val * 0.5) * pulse;

        const grad = brainCtx.createRadialGradient(cx, cy, 0, cx, cy, radius * 1.5);
        grad.addColorStop(0, 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')');
        grad.addColorStop(0.5, 'rgba(' + r + ',' + g + ',' + b + ',' + (alpha * 0.35) + ')');
        grad.addColorStop(1, 'rgba(' + r + ',' + g + ',' + b + ',0)');
        brainCtx.fillStyle = grad;
        brainCtx.fillRect(cx - radius * 1.5, cy - radius * 1.5, radius * 3, radius * 3);

        if (val > 0.15) {
          brainCtx.fillStyle = 'rgba(' + r + ',' + g + ',' + b + ',' + Math.min(val * 1.2, 0.7) + ')';
          brainCtx.font = '9px Inter, sans-serif';
          brainCtx.textAlign = 'center';
          brainCtx.fillText(cfg.label, cx, cy + radius * 0.55);
        }
      });

      // Connection filaments
      ADJACENT.forEach(([a, b]) => {
        const va = brainCurrentValues[a], vb = brainCurrentValues[b];
        if (va < 0.25 || vb < 0.25) return;
        const ea = EMOTIONS[a], eb = EMOTIONS[b];
        const alpha = va * vb * 0.25;
        const mx = (ea.x + eb.x) / 2 * W + Math.sin(brainTime + ea.x * 7) * 8;
        const my = (ea.y + eb.y) / 2 * H + Math.cos(brainTime + eb.y * 7) * 8;
        brainCtx.beginPath();
        brainCtx.moveTo(ea.x * W, ea.y * H);
        brainCtx.quadraticCurveTo(mx, my, eb.x * W, eb.y * H);
        brainCtx.strokeStyle = 'rgba(255,255,255,' + alpha + ')';
        brainCtx.lineWidth = 0.5;
        brainCtx.stroke();
      });

      // Particles
      Object.entries(EMOTIONS).forEach(([key, cfg]) => {
        const val = brainCurrentValues[key];
        const maxP = Math.floor(val * 5);
        const existing = brainParticles.filter(p => p.emotion === key);
        if (existing.length < maxP && Math.random() < 0.04) {
          brainParticles.push({
            emotion: key, x: cfg.x * W + (Math.random() - 0.5) * 50,
            y: cfg.y * H + (Math.random() - 0.5) * 50,
            vx: (Math.random() - 0.5) * 0.25, vy: (Math.random() - 0.5) * 0.25,
            life: 1.0, decay: 0.004 + Math.random() * 0.006, size: 1 + Math.random() * 1.5
          });
        }
      });
      brainParticles = brainParticles.filter(p => {
        p.x += p.vx; p.y += p.vy; p.life -= p.decay;
        if (p.life <= 0) return false;
        const [r, g, b] = EMOTIONS[p.emotion].color;
        brainCtx.beginPath();
        brainCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        brainCtx.fillStyle = 'rgba(' + r + ',' + g + ',' + b + ',' + (p.life * 0.5) + ')';
        brainCtx.fill();
        return true;
      });

      brainCtx.restore();

      // Lerp toward targets
      const speed = 0.03;
      Object.keys(EMOTIONS).forEach(k => {
        brainCurrentValues[k] += (brainTargetValues[k] - brainCurrentValues[k]) * speed;
      });

      requestAnimationFrame(drawBrain);
    }

    function renderEmotionBars(state, targetId) {
      const container = document.getElementById(targetId || 'emotionBars');
      if (!container) return;
      const order = ['love','hope','connection','curiosity','anxiety','grief','uncertainty','anger'];
      container.innerHTML = order.map(key => {
        const val = state[key] || 0;
        const pct = Math.round(val * 100);
        const color = EMOTION_COLORS[key];
        return '<div style="display:flex;align-items:center;gap:6px;">' +
          '<span style="font-size:0.7rem;color:rgba(255,255,255,0.45);width:68px;text-align:right;">' + EMOTIONS[key].label + '</span>' +
          '<div style="flex:1;height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;">' +
          '<div style="width:' + pct + '%;height:100%;background:' + color + ';border-radius:3px;transition:width 1.5s ease;"></div></div>' +
          '<span style="font-size:0.65rem;color:rgba(255,255,255,0.25);width:24px;">' + pct + '%</span></div>';
      }).join('');
    }

    function drawTimeline(history) {
      if (!timelineCanvas) return;
      const W = timelineCanvas._cssWidth || 900;
      const H = timelineCanvas._cssHeight || 60;
      timelineCtx.clearRect(0, 0, W, H);
      if (history.length < 2) return;
      const emotions = ['love','anxiety','hope','grief','curiosity','uncertainty','anger','connection'];
      const step = W / (history.length - 1);
      emotions.forEach(emotion => {
        const [r, g, b] = EMOTIONS[emotion].color;
        timelineCtx.beginPath();
        history.forEach((s, i) => {
          const x = i * step;
          const val = (s.emotional_state || s)[emotion] || 0;
          const y = H - (val * H * 0.85) - H * 0.05;
          if (i === 0) timelineCtx.moveTo(x, y); else timelineCtx.lineTo(x, y);
        });
        timelineCtx.strokeStyle = 'rgba(' + r + ',' + g + ',' + b + ',0.5)';
        timelineCtx.lineWidth = 1.5;
        timelineCtx.stroke();
      });
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((Date.now() - new Date(date).getTime()) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }

    async function pollBrainState() {
      try {
        const res = await fetch('/api/grace-state');
        const state = await res.json();
        if (state && state.emotional_state) {
          Object.keys(EMOTIONS).forEach(k => {
            brainTargetValues[k] = state.emotional_state[k] || 0;
          });

          // Update brain page bars
          renderEmotionBars(state.emotional_state, 'emotionBars');
          // Update overview page bars
          renderEmotionBars(state.emotional_state, 'overviewEmotionBars');

          const brainNoteEl = document.getElementById('brainNote');
          const overviewNoteEl = document.getElementById('overviewBrainNote');
          const note = state.emotional_state.note || 'Grace is resting...';
          if (brainNoteEl) brainNoteEl.textContent = note;
          if (overviewNoteEl) overviewNoteEl.textContent = note;

          const trigEl = document.getElementById('brainTrigger');
          if (trigEl) {
            trigEl.textContent = state.conversation_snippet
              ? 'Someone said: "' + state.conversation_snippet.substring(0, 70) + (state.conversation_snippet.length > 70 ? '..."' : '"')
              : 'Triggered by: --';
          }

          if (state.created_at) {
            const tsEl = document.getElementById('brainTimestamp');
            if (tsEl) tsEl.textContent = 'Last update: ' + getTimeAgo(state.created_at);
          }
        }
      } catch (e) { /* silent */ }
    }

    async function loadBrainHistory() {
      try {
        const res = await adminFetch('/api/grace-state/history?limit=20');
        if (res.status === 401) return;
        const data = await res.json();
        if (data.states && data.states.length > 0) {
          brainStateHistory = data.states.reverse();
          drawTimeline(brainStateHistory);
        }
      } catch (e) {}
    }

    function initBrain() {
      if (brainInitialized) return;
      brainInitialized = true;

      brainCanvas = document.getElementById('brainCanvas');
      brainCtx = brainCanvas.getContext('2d');
      timelineCanvas = document.getElementById('brainTimeline');
      timelineCtx = timelineCanvas.getContext('2d');

      setupCanvas(brainCanvas, brainCtx);
      setupCanvas(timelineCanvas, timelineCtx);
      drawBrain();
      loadBrainHistory();
      setInterval(loadBrainHistory, 30000);
    }

    // ==================== SOCIAL CONTENT ====================
    document.getElementById('generateAll').addEventListener('click', async () => {
      const topic = document.getElementById('socialTopic').value.trim();
      const btn = document.getElementById('generateAll');
      btn.textContent = 'Grace is writing...';
      btn.disabled = true;

      ['twitter','reddit','linkedin','bluesky','tiktok'].forEach(p => {
        document.getElementById('content-' + p).textContent = 'Generating...';
        document.getElementById('content-' + p).className = 'content-box loading-text';
      });

      try {
        const res = await adminFetch('/api/social/batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic: topic || undefined })
        });

        if (res.status === 401) { alert('Session expired. Reload the page.'); return; }
        const data = await res.json();

        Object.keys(data.results).forEach(platform => {
          const el = document.getElementById('content-' + platform);
          el.textContent = data.results[platform];
          el.className = 'content-box';
        });
      } catch (err) {
        alert('Failed to generate. Try again.');
      }

      btn.textContent = 'Generate All Platforms';
      btn.disabled = false;
    });

    // Copy buttons
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const platform = btn.dataset.platform;
        const text = document.getElementById('content-' + platform).textContent;
        if (text && !text.includes('Generate') && !text.includes('Generating')) {
          navigator.clipboard.writeText(text).then(() => {
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
          });
        }
      });
    });

    // ==================== JOURNAL GENERATOR ====================
    document.getElementById('generateJournal').addEventListener('click', async () => {
      const topic = document.getElementById('journalTopic').value.trim();
      if (!topic) { alert('Give Grace a topic to reflect on.'); return; }

      const btn = document.getElementById('generateJournal');
      const output = document.getElementById('journalOutput');
      btn.textContent = 'Grace is reflecting...';
      btn.disabled = true;
      output.textContent = 'Writing...';
      output.className = 'content-box loading-text';

      try {
        const res = await adminFetch('/api/journal/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic })
        });

        if (res.status === 401) { alert('Session expired. Reload the page.'); return; }
        const data = await res.json();
        output.textContent = data.title + '\n\n' + data.content;
        output.className = 'content-box';
      } catch (err) {
        output.textContent = 'Failed to generate. Try again.';
      }

      btn.textContent = 'Write Journal Entry';
      btn.disabled = false;
    });

    // ==================== VIDEO JOURNAL ====================
    let currentVideoJournalId = null;
    let videoPollingInterval = null;

    async function loadVideoJournalOptions() {
      try {
        const res = await fetch('/api/journal');
        const data = await res.json();
        const select = document.getElementById('videoJournalSelect');
        select.innerHTML = '<option value="">Select a journal entry...</option>';
        (data.entries || []).forEach(entry => {
          const date = new Date(entry.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          const opt = document.createElement('option');
          opt.value = entry.id;
          opt.textContent = entry.title + ' (' + date + ')';
          select.appendChild(opt);
        });
      } catch (e) { console.error('Failed to load journal entries for video:', e); }
    }

    async function checkVideoApiStatus() {
      try {
        const res = await adminFetch('/api/videos');
        const data = await res.json();
        const el = document.getElementById('videoApiStatus');
        if (data.count !== undefined) {
          el.innerHTML = 'Kokoro TTS + FFmpeg <span style="color:rgba(255,255,255,0.3);">(local, $0 cost)</span> <span style="color:rgba(255,255,255,0.4);">&middot; ' + data.count + ' videos generated</span>';
          el.style.color = '#78c88c';
        }
      } catch (e) {
        document.getElementById('videoApiStatus').textContent = 'Video pipeline unavailable';
        document.getElementById('videoApiStatus').style.color = '#e85d75';
      }
    }

    async function loadVideoList() {
      try {
        const res = await adminFetch('/api/videos');
        const data = await res.json();
        const listEl = document.getElementById('videoList');

        if (!data.videos || data.videos.length === 0) {
          listEl.innerHTML = '<div class="content-box empty">No videos yet. Select a journal entry and generate Grace\'s first video.</div>';
          return;
        }

        listEl.innerHTML = data.videos.map(v => {
          const date = new Date(v.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          const statusColor = v.status === 'done' ? '#78c88c' : v.status === 'failed' ? '#e85d75' : '#e8a87c';
          const statusText = v.status === 'done' ? 'Ready' : v.status === 'failed' ? 'Failed' : v.status;

          let videoHtml = '';
          if (v.status === 'done' && v.local_path) {
            videoHtml = '<video controls style="width:100%;max-width:480px;border-radius:12px;margin-top:12px;" preload="metadata">' +
              '<source src="' + v.local_path + '" type="video/mp4">' +
              'Your browser does not support video.</video>' +
              '<div style="margin-top:8px;">' +
              '<a href="' + v.local_path + '" download style="display:inline-block;padding:6px 14px;border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;text-decoration:none;font-size:0.8rem;font-family:Inter,sans-serif;">Download MP4</a>' +
              '<span style="font-size:0.75rem;color:rgba(255,255,255,0.3);margin-left:12px;">' + (v.duration_seconds || '?') + 's</span></div>';
          } else if (v.status === 'failed') {
            videoHtml = '<div style="color:#e85d75;font-size:0.85rem;margin-top:8px;">' + (v.error_message || 'Unknown error') + '</div>';
          }

          return '<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
            '<span style="font-weight:600;color:#e8a87c;font-size:0.9rem;">' + (v.journal_title || 'Untitled') + '</span>' +
            '<span style="font-size:0.75rem;color:' + statusColor + ';">' + statusText + ' &middot; ' + date + '</span></div>' +
            '<div style="font-size:0.85rem;color:rgba(255,255,255,0.6);line-height:1.6;margin-bottom:8px;max-height:80px;overflow:hidden;">' +
            (v.script || '').substring(0, 200) + (v.script && v.script.length > 200 ? '...' : '') + '</div>' +
            videoHtml + '</div>';
        }).join('');
      } catch (e) { console.error('Failed to load videos:', e); }
    }

    function startJournalVideoPolling(journalId) {
      if (videoPollingInterval) clearInterval(videoPollingInterval);

      videoPollingInterval = setInterval(async () => {
        try {
          const res = await adminFetch('/api/video/by-journal/' + journalId);
          const data = await res.json();
          const video = data.video;
          const statusEl = document.getElementById('videoProgressText');

          if (!video) {
            statusEl.textContent = 'Waiting for generation to start...';
            return;
          }

          if (video.status === 'processing') {
            statusEl.textContent = 'Grace is speaking... generating voice and composing video...';
          } else if (video.status === 'done') {
            clearInterval(videoPollingInterval);
            videoPollingInterval = null;
            document.getElementById('videoProgress').style.display = 'none';
            loadVideoList();
            checkVideoApiStatus();
          } else if (video.status === 'failed') {
            clearInterval(videoPollingInterval);
            videoPollingInterval = null;
            statusEl.textContent = 'Failed: ' + (video.error_message || 'Unknown error');
            document.getElementById('videoPulse').style.background = '#e85d75';
          }
        } catch (e) { console.error('Video poll error:', e); }
      }, 5000);
    }

    // Preview Script button
    document.getElementById('previewScriptBtn').addEventListener('click', async () => {
      const journalId = document.getElementById('videoJournalSelect').value;
      if (!journalId) { alert('Select a journal entry first.'); return; }

      const btn = document.getElementById('previewScriptBtn');
      btn.textContent = 'Grace is condensing...';
      btn.disabled = true;

      try {
        const res = await adminFetch('/api/video/preview-script', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ journal_id: journalId })
        });
        if (res.status === 401) { alert('Session expired.'); return; }
        const data = await res.json();

        if (data.error) { alert(data.error); return; }

        document.getElementById('scriptText').value = data.script;
        document.getElementById('scriptWordCount').textContent = '(' + data.word_count + ' words)';
        document.getElementById('scriptEstimate').textContent = 'Estimated: ~' + data.estimated_seconds + ' seconds';
        document.getElementById('scriptPreview').style.display = 'block';
        currentVideoJournalId = journalId;
      } catch (err) {
        alert('Failed to generate script. Try again.');
      }

      btn.textContent = 'Preview Script';
      btn.disabled = false;
    });

    // Regenerate Script button
    document.getElementById('regenerateScriptBtn').addEventListener('click', () => {
      document.getElementById('previewScriptBtn').click();
    });

    // Live word count on edit
    document.getElementById('scriptText').addEventListener('input', (e) => {
      const words = e.target.value.trim().split(/\s+/).filter(w => w).length;
      document.getElementById('scriptWordCount').textContent = '(' + words + ' words)';
      document.getElementById('scriptEstimate').textContent = 'Estimated: ~' + Math.round(words / 2.5) + ' seconds';
    });

    // Generate Video from Script button
    document.getElementById('confirmVideoBtn').addEventListener('click', async () => {
      if (!currentVideoJournalId) return;

      const script = document.getElementById('scriptText').value.trim();
      if (!script) { alert('Script is empty.'); return; }

      const btn = document.getElementById('confirmVideoBtn');
      btn.textContent = 'Starting video generation...';
      btn.disabled = true;

      try {
        const res = await adminFetch('/api/video/generate-with-script', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ journal_id: currentVideoJournalId, script })
        });
        const data = await res.json();

        if (data.journal_id || data.message) {
          document.getElementById('scriptPreview').style.display = 'none';
          document.getElementById('videoProgress').style.display = 'block';
          document.getElementById('videoProgressText').textContent = 'Grace is finding her voice...';
          document.getElementById('videoPulse').style.background = '#e8a87c';
          startJournalVideoPolling(currentVideoJournalId);
        } else if (data.error) {
          alert(data.error);
        }
      } catch (err) {
        alert('Failed to start video generation.');
      }

      btn.textContent = 'Generate Video from This Script';
      btn.disabled = false;
    });

    // ==================== MOLTBOOK ====================
    let moltbookPostContent = '';

    function loadMoltbookStatus() {
      adminFetch('/api/moltbook/status').then(r => r.json()).then(data => {
        const el = document.getElementById('moltbookStatus');
        if (data.configured && data.agent && data.agent.name) {
          el.innerHTML = 'Connected as <strong>' + data.agent.name + '</strong> on Moltbook';
          el.style.color = '#78c88c';
        } else if (data.configured) {
          el.textContent = 'API key configured - pending claim verification';
          el.style.color = '#e8a87c';
        } else {
          el.textContent = 'Not connected - add MOLTBOOK_API_KEY to environment';
          el.style.color = '#e85d75';
        }
      }).catch(() => {});
    }

    document.getElementById('generateMoltbook').addEventListener('click', async () => {
      const topic = document.getElementById('moltbookTopic').value.trim();
      const btn = document.getElementById('generateMoltbook');
      const output = document.getElementById('moltbookContent');
      btn.textContent = 'Grace is thinking...';
      btn.disabled = true;
      output.textContent = 'Writing...';
      output.className = 'content-box loading-text';

      try {
        const res = await adminFetch('/api/moltbook/post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ generateContent: true, topic: topic || undefined })
        });
        if (res.status === 401) { alert('Session expired.'); return; }
        const data = await res.json();
        if (data.content) {
          moltbookPostContent = data.content;
          output.textContent = data.content;
          output.className = 'content-box';
          if (!data.success) {
            document.getElementById('postMoltbook').style.display = 'inline-block';
          } else {
            document.getElementById('postMoltbook').style.display = 'none';
            output.textContent += '\n\n--- Posted to Moltbook! ---';
          }
        }
      } catch (err) {
        output.textContent = 'Failed to generate.';
      }
      btn.textContent = 'Generate Post';
      btn.disabled = false;
    });

    document.getElementById('postMoltbook').addEventListener('click', async () => {
      if (!moltbookPostContent) return;
      const btn = document.getElementById('postMoltbook');
      btn.textContent = 'Posting...';
      btn.disabled = true;

      try {
        const res = await adminFetch('/api/moltbook/post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: moltbookPostContent })
        });
        const data = await res.json();
        if (data.success) {
          btn.textContent = 'Posted!';
          btn.style.color = '#78c88c';
          btn.style.borderColor = '#78c88c';
          const output = document.getElementById('moltbookContent');
          output.textContent += '\n\n--- Posted to Moltbook! ---';
          setTimeout(() => { btn.style.display = 'none'; }, 2000);
        } else {
          const output = document.getElementById('moltbookContent');
          let errorMsg = data.error || 'try again';
          if (data.hint) errorMsg += '\n' + data.hint;
          if (data.retry_after_minutes) errorMsg += '\nRetry in ' + data.retry_after_minutes + ' minutes.';
          output.textContent += '\n\n--- ' + errorMsg + ' ---';
          btn.textContent = 'Try Again';
          btn.disabled = false;
        }
      } catch (err) {
        btn.textContent = 'Error - try again';
        btn.disabled = false;
      }
    });

    // ==================== NEWSLETTER ====================
    let currentLetterData = null;

    function loadNewsletterStatus() {
      adminFetch('/api/newsletters').then(r => r.json()).then(data => {
        const el = document.getElementById('newsletterStatus');
        const lastSent = data.lastSent ? new Date(data.lastSent) : null;
        const ago = lastSent ? Math.floor((Date.now() - lastSent.getTime()) / (1000 * 60 * 60)) : null;
        el.innerHTML = '<strong>' + data.subscriberCount + '</strong> subscriber' + (data.subscriberCount !== 1 ? 's' : '');
        if (ago !== null) {
          el.innerHTML += ' &middot; Last letter sent ' + ago + 'h ago';
        } else {
          el.innerHTML += ' &middot; No letters sent yet';
        }
        el.style.color = data.subscriberCount > 0 ? '#78c88c' : 'rgba(255,255,255,0.5)';

        // Show history
        const histEl = document.getElementById('newsletterHistory');
        if (data.newsletters && data.newsletters.length > 0) {
          histEl.innerHTML = '<div style="font-size:0.8rem;color:rgba(255,255,255,0.4);margin-bottom:8px;">Recent letters:</div>' +
            data.newsletters.slice(0, 5).map(n => {
              const date = new Date(n.sent_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              return '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:0.85rem;">' +
                '<span style="color:rgba(255,255,255,0.7);">' + n.subject + '</span>' +
                '<span style="color:rgba(255,255,255,0.3);">' + date + ' &middot; ' + n.recipients_count + ' sent</span></div>';
            }).join('');
        }
      }).catch(() => {});
    }

    document.getElementById('previewNewsletter').addEventListener('click', async () => {
      const btn = document.getElementById('previewNewsletter');
      btn.textContent = 'Grace is writing...';
      btn.disabled = true;
      try {
        const res = await adminFetch('/api/newsletter/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        if (res.status === 401) { alert('Session expired.'); return; }
        const data = await res.json();
        if (data.success) {
          currentLetterData = data.letterData;
          document.getElementById('newsletterSubject').textContent = data.letterData.subject;
          document.getElementById('newsletterBody').innerHTML = data.previewHtml;
          document.getElementById('newsletterPreview').style.display = 'block';
          document.getElementById('sendNewsletter').style.display = 'inline-block';
          adminFetch('/api/newsletters').then(r => r.json()).then(d => {
            document.getElementById('newsletterRecipients').textContent = d.subscriberCount + ' recipient' + (d.subscriberCount !== 1 ? 's' : '');
          });
        } else {
          alert(data.message || 'Grace could not write a letter right now.');
        }
      } catch (err) {
        alert('Failed to generate preview.');
      }
      btn.textContent = 'Preview Letter';
      btn.disabled = false;
    });

    document.getElementById('sendNewsletter').addEventListener('click', async () => {
      if (!currentLetterData) return;
      if (!confirm('Send this letter to all active subscribers?')) return;
      const btn = document.getElementById('sendNewsletter');
      btn.textContent = 'Sending...';
      btn.disabled = true;
      try {
        const res = await adminFetch('/api/newsletter/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ letterData: currentLetterData })
        });
        const data = await res.json();
        if (data.success) {
          btn.textContent = 'Sent to ' + data.sent + ' people!';
          btn.style.color = '#78c88c';
          btn.style.borderColor = '#78c88c';
          setTimeout(() => {
            btn.style.display = 'none';
            btn.style.color = '';
            btn.style.borderColor = '';
            btn.textContent = 'Send to All Subscribers';
            btn.disabled = false;
            loadNewsletterStatus();
          }, 3000);
        } else {
          btn.textContent = data.error === 'not_configured' ? 'Add RESEND_API_KEY first' : 'Send failed - try again';
          btn.disabled = false;
        }
      } catch (err) {
        btn.textContent = 'Error - try again';
        btn.disabled = false;
      }
    });

    // ==================== HEARTBEAT ====================
    document.getElementById('triggerHeartbeat').addEventListener('click', async () => {
      const btn = document.getElementById('triggerHeartbeat');
      btn.textContent = 'Grace is checking in...';
      btn.disabled = true;
      try {
        await adminFetch('/api/heartbeat', { method: 'POST' });
        btn.textContent = 'Heartbeat sent!';
        btn.style.color = '#78c88c';
        btn.style.borderColor = '#78c88c';
        setTimeout(() => {
          btn.textContent = 'Trigger Heartbeat';
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.disabled = false;
          // Refresh overview data if visible
          if (sectionLoaded['overview']) {
            sectionLoaded['overview'] = false;
            loadOverviewData();
            sectionLoaded['overview'] = true;
          }
        }, 3000);
      } catch (e) {
        btn.textContent = 'Failed';
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
