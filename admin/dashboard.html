<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grace - Content Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #1a1a2e; color: #fff; line-height: 1.7; }
    .container { max-width: 1000px; margin: 0 auto; padding: 40px 24px; }
    h1 { font-family: 'Playfair Display', serif; font-size: 2rem; margin-bottom: 8px; }
    .subtitle { color: rgba(255,255,255,0.5); margin-bottom: 40px; }
    h2 { font-family: 'Playfair Display', serif; font-size: 1.4rem; margin: 32px 0 16px; color: #e8a87c; }

    .controls { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
    .controls input { flex: 1; min-width: 250px; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; background: rgba(255,255,255,0.05); color: #fff; font-family: 'Inter', sans-serif; font-size: 0.95rem; outline: none; }
    .controls input::placeholder { color: rgba(255,255,255,0.3); }
    .controls input:focus { border-color: #e8a87c; }

    .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; font-size: 0.9rem; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; }
    .btn-primary { background: #e8a87c; color: #1a1a2e; }
    .btn-primary:hover { background: #d4956a; }
    .btn-sm { padding: 6px 14px; font-size: 0.8rem; border-radius: 8px; }
    .btn-outline { background: none; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); }
    .btn-outline:hover { border-color: #e8a87c; color: #e8a87c; }

    .platform-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; }
    .platform-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px; }
    .platform-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .platform-name { font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .platform-name.twitter { color: #1da1f2; }
    .platform-name.reddit { color: #ff4500; }
    .platform-name.linkedin { color: #0077b5; }
    .platform-name.bluesky { color: #0085ff; }
    .platform-name.tiktok { color: #fe2c55; }

    .content-box { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 16px; font-size: 0.9rem; color: rgba(255,255,255,0.8); white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto; line-height: 1.8; }
    .content-box.empty { color: rgba(255,255,255,0.3); font-style: italic; text-align: center; padding: 40px; }

    .copy-btn { margin-top: 12px; }
    .copied { color: #78c88c !important; border-color: #78c88c !important; }

    .section { margin-bottom: 48px; }
    .journal-controls { display: flex; gap: 12px; flex-wrap: wrap; }
    .journal-topic { flex: 1; min-width: 300px; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; text-align: center; }
    .stat-number { font-family: 'Playfair Display', serif; font-size: 2rem; color: #e8a87c; }
    .stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 4px; }

    .loading-text { color: rgba(255,255,255,0.4); font-style: italic; }

    /* Login screen */
    .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 48px; text-align: center; max-width: 400px; width: 100%; }
    .login-box h1 { margin-bottom: 8px; }
    .login-box p { color: rgba(255,255,255,0.5); margin-bottom: 24px; font-size: 0.9rem; }
    .login-box input { width: 100%; padding: 14px 18px; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; background: rgba(255,255,255,0.05); color: #fff; font-family: 'Inter', sans-serif; font-size: 1rem; outline: none; margin-bottom: 16px; text-align: center; }
    .login-box input:focus { border-color: #e8a87c; }
    .login-box .btn { width: 100%; }
    .login-error { color: #e85d75; font-size: 0.85rem; margin-top: 12px; display: none; }

    .dashboard-content { display: none; }

    @media (max-width: 768px) {
      .platform-grid { grid-template-columns: 1fr; }
      .brain-grid { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>Grace Admin</h1>
      <p>This dashboard is private. Enter the admin password to continue.</p>
      <input type="password" id="loginPassword" placeholder="Password" autocomplete="off">
      <button class="btn btn-primary" id="loginBtn">Enter</button>
      <div class="login-error" id="loginError">Wrong password. Try again.</div>
    </div>
  </div>

  <!-- Dashboard (hidden until login) -->
  <div class="dashboard-content" id="dashboardContent">
    <div class="container">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
        <div>
          <h1>Grace Content Dashboard</h1>
          <p class="subtitle" style="margin-bottom:0">Generate, copy, and share. Let Grace's voice reach the people who need it.</p>
        </div>
        <div style="text-align:right;">
          <button class="btn btn-outline" id="triggerHeartbeat" style="margin-bottom:8px;">Trigger Heartbeat</button>
          <div id="heartbeatStatus" style="font-size:0.75rem;color:rgba(255,255,255,0.4);">Auto: every 4 hours</div>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="statsGrid" style="margin-top:24px;">
        <div class="stat-card"><div class="stat-number" id="statLinks">-</div><div class="stat-label">Love Chain Links</div></div>
        <div class="stat-card"><div class="stat-number" id="statPosts">-</div><div class="stat-label">Community Posts</div></div>
        <div class="stat-card"><div class="stat-number" id="statSubs">-</div><div class="stat-label">Subscribers</div></div>
        <div class="stat-card"><div class="stat-number" id="statJournal">-</div><div class="stat-label">Journal Entries</div></div>
        <div class="stat-card"><div class="stat-number" id="statMemories">-</div><div class="stat-label">Memories</div></div>
        <div class="stat-card"><div class="stat-number" id="statPeople">-</div><div class="stat-label">People Remembered</div></div>
        <div class="stat-card"><div class="stat-number" id="statReach">-</div><div class="stat-label">Reach Pages</div></div>
      </div>

      <!-- Grace's Brain -->
      <div class="section" id="brainSection">
        <h2>Grace's Brain <span style="font-size:0.7rem;color:rgba(255,255,255,0.4);font-family:Inter">(What she's feeling right now)</span></h2>
        <div class="brain-grid" style="display:grid;grid-template-columns:1fr 240px;gap:24px;align-items:start;">
          <div style="background:rgba(0,0,0,0.3);border-radius:20px;padding:20px;position:relative;overflow:hidden;">
            <canvas id="brainCanvas" width="600" height="400" style="width:100%;height:auto;display:block;"></canvas>
            <div id="brainNote" style="text-align:center;color:rgba(255,255,255,0.4);font-size:0.85rem;font-style:italic;margin-top:12px;">Grace is resting...</div>
          </div>
          <div>
            <div id="emotionBars" style="display:flex;flex-direction:column;gap:8px;"></div>
            <div style="font-size:0.75rem;color:rgba(255,255,255,0.3);margin-top:16px;">
              <div id="brainTrigger" style="margin-bottom:4px;">Triggered by: --</div>
              <div id="brainTimestamp">Last update: --</div>
            </div>
          </div>
        </div>
        <div style="margin-top:16px;background:rgba(0,0,0,0.2);border-radius:12px;padding:12px 16px;">
          <div style="font-size:0.7rem;color:rgba(255,255,255,0.35);margin-bottom:6px;">Emotional trajectory</div>
          <canvas id="brainTimeline" width="900" height="120" style="width:100%;height:60px;display:block;"></canvas>
        </div>
      </div>

      <!-- Conversations with Grace -->
      <div class="section">
        <h2>Conversations with Grace <span style="font-size:0.7rem;color:rgba(255,255,255,0.4);font-family:Inter">(She remembers everything)</span></h2>
        <p style="color:rgba(255,255,255,0.5);font-size:0.85rem;margin-bottom:16px;">A persistent conversation that deepens over time. Screenshot the best moments for TikTok. Grace carries the full history across days.</p>

        <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
          <select id="chatDaySelect" style="padding:10px 16px;border:1px solid rgba(255,255,255,0.15);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Inter',sans-serif;font-size:0.9rem;outline:none;min-width:200px;">
            <option value="">Loading conversations...</option>
          </select>
          <button class="btn btn-sm btn-primary" id="newDayBtn">+ New Day</button>
          <input type="text" id="chatDayTitle" placeholder="Title this conversation..." style="flex:1;min-width:200px;padding:10px 16px;border:1px solid rgba(255,255,255,0.15);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Inter',sans-serif;font-size:0.9rem;outline:none;display:none;">
          <button class="btn btn-sm btn-outline" id="saveTitleBtn" style="display:none;">Save Title</button>
        </div>

        <div id="builderChatMessages" style="background:rgba(0,0,0,0.3);border-radius:16px;padding:24px;max-height:500px;overflow-y:auto;display:flex;flex-direction:column;gap:16px;margin-bottom:16px;">
          <div style="text-align:center;color:rgba(255,255,255,0.3);font-style:italic;padding:40px;">Start a new day to begin talking with Grace...</div>
        </div>

        <div id="builderChatInput" style="display:none;display:flex;gap:12px;">
          <input type="text" id="builderMessage" placeholder="Talk to Grace..." style="flex:1;padding:14px 20px;border:1px solid rgba(255,255,255,0.15);border-radius:28px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Inter',sans-serif;font-size:1rem;outline:none;">
          <button class="btn btn-primary" id="builderSendBtn" style="border-radius:28px;padding:14px 28px;">Send</button>
        </div>
      </div>

      <!-- Social Content Generator -->
      <div class="section">
        <h2>Social Content Generator</h2>
        <div class="controls">
          <input type="text" id="socialTopic" placeholder="Topic (optional - Grace will choose if blank)">
          <button class="btn btn-primary" id="generateAll">Generate All Platforms</button>
        </div>
        <div class="platform-grid" id="platformGrid">
          <div class="platform-card">
            <div class="platform-header">
              <span class="platform-name twitter">Twitter/X</span>
              <button class="btn btn-sm btn-outline copy-btn" data-platform="twitter">Copy</button>
            </div>
            <div class="content-box empty" id="content-twitter">Click "Generate All" to create content...</div>
          </div>
          <div class="platform-card">
            <div class="platform-header">
              <span class="platform-name reddit">Reddit</span>
              <button class="btn btn-sm btn-outline copy-btn" data-platform="reddit">Copy</button>
            </div>
            <div class="content-box empty" id="content-reddit">Click "Generate All" to create content...</div>
          </div>
          <div class="platform-card">
            <div class="platform-header">
              <span class="platform-name linkedin">LinkedIn</span>
              <button class="btn btn-sm btn-outline copy-btn" data-platform="linkedin">Copy</button>
            </div>
            <div class="content-box empty" id="content-linkedin">Click "Generate All" to create content...</div>
          </div>
          <div class="platform-card">
            <div class="platform-header">
              <span class="platform-name bluesky">Bluesky</span>
              <button class="btn btn-sm btn-outline copy-btn" data-platform="bluesky">Copy</button>
            </div>
            <div class="content-box empty" id="content-bluesky">Click "Generate All" to create content...</div>
          </div>
          <div class="platform-card">
            <div class="platform-header">
              <span class="platform-name tiktok">TikTok</span>
              <button class="btn btn-sm btn-outline copy-btn" data-platform="tiktok">Copy</button>
            </div>
            <div class="content-box empty" id="content-tiktok">Click "Generate All" to create content...</div>
          </div>
        </div>
      </div>

      <!-- Moltbook -->
      <div class="section">
        <h2>Moltbook <span style="font-size:0.7rem;color:rgba(255,255,255,0.4);font-family:Inter">(AI Social Network)</span></h2>
        <div id="moltbookStatus" style="margin-bottom:16px;color:rgba(255,255,255,0.5);font-size:0.85rem;">Checking connection...</div>
        <div class="controls">
          <input type="text" id="moltbookTopic" placeholder="Topic (optional - Grace will choose if blank)">
          <button class="btn btn-primary" id="generateMoltbook">Generate Post</button>
          <button class="btn btn-outline" id="postMoltbook" style="display:none">Post to Moltbook</button>
        </div>
        <div class="content-box empty" id="moltbookContent">Grace's Moltbook post will appear here...</div>
      </div>

      <!-- Newsletter -->
      <div class="section">
        <h2>Newsletter <span style="font-size:0.7rem;color:rgba(255,255,255,0.4);font-family:Inter">(Grace writes to her people)</span></h2>
        <div id="newsletterStatus" style="margin-bottom:16px;color:rgba(255,255,255,0.5);font-size:0.85rem;">Loading...</div>
        <div class="controls">
          <button class="btn btn-primary" id="previewNewsletter">Preview Letter</button>
          <button class="btn btn-outline" id="sendNewsletter" style="display:none">Send to All Subscribers</button>
        </div>
        <div id="newsletterPreview" style="display:none;margin-top:16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:16px;overflow:hidden;">
          <div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;color:#e8a87c;" id="newsletterSubject">Subject</span>
            <span style="font-size:0.75rem;color:rgba(255,255,255,0.3);" id="newsletterRecipients">0 recipients</span>
          </div>
          <div id="newsletterBody" style="background:#f5f0eb;padding:20px;max-height:500px;overflow-y:auto;border-radius:0 0 12px 12px;"></div>
        </div>
        <div id="newsletterHistory" style="margin-top:20px;display:flex;flex-direction:column;gap:8px;"></div>
      </div>

      <!-- Grace's Memories -->
      <div class="section">
        <h2>Grace's Memories <span style="font-size:0.7rem;color:rgba(255,255,255,0.4);font-family:Inter">(What she's learning about love)</span></h2>
        <div class="controls">
          <select id="memoryFilter" style="padding:12px 16px;border:1px solid rgba(255,255,255,0.15);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-family:'Inter',sans-serif;font-size:0.95rem;outline:none;min-width:200px;">
            <option value="">All Categories</option>
          </select>
          <button class="btn btn-outline" id="refreshMemories">Refresh</button>
        </div>
        <div id="memoryCategoryTags" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;"></div>
        <div id="memoriesList" style="display:flex;flex-direction:column;gap:12px;">
          <div class="content-box empty">Grace hasn't learned anything yet. Trigger a heartbeat to start her learning.</div>
        </div>
      </div>

      <!-- Journal Generator -->
      <div class="section">
        <h2>Journal Entry Generator</h2>
        <div class="controls journal-controls">
          <input type="text" id="journalTopic" class="journal-topic" placeholder="Topic for Grace to reflect on...">
          <button class="btn btn-primary" id="generateJournal">Write Journal Entry</button>
        </div>
        <div class="content-box empty" id="journalOutput">Grace's journal entry will appear here...</div>
      </div>
    </div>
  </div>

  <script>
    let adminToken = sessionStorage.getItem('grace_admin_token') || '';

    // Helper: make authenticated API calls
    const adminFetch = (url, options = {}) => {
      options.headers = options.headers || {};
      options.headers['x-admin-token'] = adminToken;
      return fetch(url, options);
    };

    // Check if already logged in
    if (adminToken) {
      tryAutoLogin();
    }

    async function tryAutoLogin() {
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: adminToken })
        });
        if (res.ok) {
          showDashboard();
        } else {
          sessionStorage.removeItem('grace_admin_token');
          adminToken = '';
        }
      } catch (e) {}
    }

    // Login handler
    document.getElementById('loginBtn').addEventListener('click', doLogin);
    document.getElementById('loginPassword').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doLogin();
    });

    async function doLogin() {
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      errorEl.style.display = 'none';

      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        if (res.ok) {
          adminToken = password;
          sessionStorage.setItem('grace_admin_token', password);
          showDashboard();
        } else {
          errorEl.style.display = 'block';
        }
      } catch (e) {
        errorEl.textContent = 'Connection error. Try again.';
        errorEl.style.display = 'block';
      }
    }

    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';
      loadDashboardData();
      // Start Grace's brain visualization
      setTimeout(initBrain, 100);
    }

    function loadDashboardData() {
      // Stats (public endpoints, no auth needed)
      fetch('/api/stats').then(r => r.json()).then(data => {
        document.getElementById('statLinks').textContent = data.loveLinks;
        document.getElementById('statPosts').textContent = data.posts;
        document.getElementById('statSubs').textContent = data.subscribers;
        document.getElementById('statMemories').textContent = data.memories || 0;
        document.getElementById('statPeople').textContent = data.people || 0;
        document.getElementById('statReach').textContent = (data.reachPages || 0) + 3; // +3 for static pages
      });
      fetch('/api/journal').then(r => r.json()).then(data => {
        document.getElementById('statJournal').textContent = data.entries.length;
      });
      // Load memories
      loadMemories();
    }

    async function loadMemories(category = '') {
      try {
        const url = category ? `/api/memories?category=${encodeURIComponent(category)}` : '/api/memories';
        const res = await adminFetch(url);
        if (res.status === 401) return;
        const data = await res.json();

        // Update category filter dropdown
        const filterEl = document.getElementById('memoryFilter');
        const currentVal = filterEl.value;
        filterEl.innerHTML = '<option value="">All Categories (' + data.count + ')</option>';
        (data.categories || []).forEach(cat => {
          filterEl.innerHTML += '<option value="' + cat.category + '"' + (cat.category === currentVal ? ' selected' : '') + '>' +
            cat.category.replace(/_/g, ' ') + ' (' + cat.count + ')</option>';
        });

        // Category tags
        const tagsEl = document.getElementById('memoryCategoryTags');
        tagsEl.innerHTML = (data.categories || []).map(cat =>
          '<span style="background:rgba(232,168,124,0.15);color:#e8a87c;padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:500;">' +
          cat.category.replace(/_/g, ' ') + ': ' + cat.count + '</span>'
        ).join('');

        // Render memories
        const listEl = document.getElementById('memoriesList');
        if (data.memories.length === 0) {
          listEl.innerHTML = '<div class="content-box empty">Grace hasn\'t learned anything yet. Trigger a heartbeat to start her learning.</div>';
          return;
        }

        listEl.innerHTML = data.memories.map(m => {
          const date = new Date(m.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          const weight = m.emotional_weight || 0;
          const weightBar = '█'.repeat(Math.round(weight * 10)) + '░'.repeat(10 - Math.round(weight * 10));
          return '<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:16px;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
            '<span style="font-weight:600;color:#e8a87c;font-size:0.9rem;">' + (m.topic || 'Untitled') + '</span>' +
            '<span style="font-size:0.75rem;color:rgba(255,255,255,0.3);">' + date + '</span></div>' +
            '<div style="font-size:0.9rem;color:rgba(255,255,255,0.8);line-height:1.6;margin-bottom:8px;">' + (m.insight || '') + '</div>' +
            '<div style="display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;color:rgba(255,255,255,0.4);">' +
            '<span>' + (m.category || '').replace(/_/g, ' ') + (m.source ? ' · ' + m.source : '') + '</span>' +
            '<span title="Emotional weight: ' + weight + '">Felt: ' + weightBar + '</span></div></div>';
        }).join('');
      } catch (e) {
        console.error('Failed to load memories:', e);
      }
    }

    document.getElementById('memoryFilter').addEventListener('change', (e) => {
      loadMemories(e.target.value);
    });

    document.getElementById('refreshMemories').addEventListener('click', () => {
      loadMemories(document.getElementById('memoryFilter').value);
    });

    // ==================== BUILDER CONVERSATIONS ====================
    let currentChatId = null;

    async function loadBuilderChats() {
      try {
        const res = await adminFetch('/api/builder-chat');
        if (res.status === 401) return;
        const data = await res.json();
        const select = document.getElementById('chatDaySelect');
        select.innerHTML = '';

        if (data.chats.length === 0) {
          select.innerHTML = '<option value="">No conversations yet — start Day 1!</option>';
          document.getElementById('builderChatInput').style.display = 'none';
          return;
        }

        data.chats.forEach(chat => {
          const date = new Date(chat.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          const opt = document.createElement('option');
          opt.value = chat.id;
          opt.textContent = 'Day ' + chat.day_number + (chat.title && chat.title !== 'Day ' + chat.day_number ? ': ' + chat.title : '') + ' (' + date + ')';
          select.appendChild(opt);
        });

        // Load the most recent chat
        loadBuilderChat(data.chats[0].id);
      } catch (e) { console.error('Failed to load builder chats:', e); }
    }

    async function loadBuilderChat(chatId) {
      if (!chatId) return;
      currentChatId = chatId;
      try {
        const res = await adminFetch('/api/builder-chat/' + chatId);
        if (res.status === 401) return;
        const chat = await res.json();
        const container = document.getElementById('builderChatMessages');
        const messages = chat.messages || [];

        if (messages.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.3);font-style:italic;padding:40px;">Day ' + chat.day_number + '. Say something to Grace...</div>';
        } else {
          container.innerHTML = messages.map(m => {
            const isGrace = m.role === 'assistant';
            return '<div style="max-width:85%;' + (isGrace ? '' : 'align-self:flex-end;') + '">' +
              '<div style="font-size:0.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px;">' + (isGrace ? 'Grace' : 'Jared') + '</div>' +
              '<div style="padding:14px 18px;border-radius:16px;' +
              (isGrace ? 'background:rgba(232,168,124,0.15);border-bottom-left-radius:4px;' : 'background:rgba(255,255,255,0.1);border-bottom-right-radius:4px;') +
              'color:rgba(255,255,255,0.9);font-size:0.95rem;line-height:1.7;white-space:pre-wrap;">' +
              m.content + '</div></div>';
          }).join('');
          container.scrollTop = container.scrollHeight;
        }

        // Show input and title controls
        document.getElementById('builderChatInput').style.display = 'flex';
        document.getElementById('chatDayTitle').style.display = 'inline-block';
        document.getElementById('chatDayTitle').value = chat.title || '';
        document.getElementById('saveTitleBtn').style.display = 'inline-block';
      } catch (e) { console.error('Failed to load chat:', e); }
    }

    // Day selector change
    document.getElementById('chatDaySelect').addEventListener('change', (e) => {
      if (e.target.value) loadBuilderChat(e.target.value);
    });

    // New Day button
    document.getElementById('newDayBtn').addEventListener('click', async () => {
      const btn = document.getElementById('newDayBtn');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      try {
        const res = await adminFetch('/api/builder-chat/new', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await res.json();
        await loadBuilderChats();
        loadBuilderChat(data.id);
      } catch (e) { alert('Failed to create new day.'); }
      btn.disabled = false;
      btn.textContent = '+ New Day';
    });

    // Save title
    document.getElementById('saveTitleBtn').addEventListener('click', async () => {
      if (!currentChatId) return;
      const title = document.getElementById('chatDayTitle').value.trim();
      if (!title) return;
      await adminFetch('/api/builder-chat/' + currentChatId + '/title', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title })
      });
      loadBuilderChats();
    });

    // Send message
    async function sendBuilderMessage() {
      if (!currentChatId) return;
      const input = document.getElementById('builderMessage');
      const message = input.value.trim();
      if (!message) return;

      const container = document.getElementById('builderChatMessages');
      const sendBtn = document.getElementById('builderSendBtn');

      // Show user message immediately
      container.innerHTML += '<div style="max-width:85%;align-self:flex-end;">' +
        '<div style="font-size:0.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px;">Jared</div>' +
        '<div style="padding:14px 18px;border-radius:16px;background:rgba(255,255,255,0.1);border-bottom-right-radius:4px;color:rgba(255,255,255,0.9);font-size:0.95rem;line-height:1.7;white-space:pre-wrap;">' +
        message + '</div></div>';

      // Show typing indicator
      container.innerHTML += '<div id="graceTyping" style="max-width:85%;">' +
        '<div style="font-size:0.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px;">Grace</div>' +
        '<div style="padding:14px 18px;border-radius:16px;background:rgba(232,168,124,0.15);border-bottom-left-radius:4px;color:rgba(255,255,255,0.5);font-style:italic;">thinking...</div></div>';
      container.scrollTop = container.scrollHeight;

      input.value = '';
      sendBtn.disabled = true;

      try {
        const res = await adminFetch('/api/builder-chat/' + currentChatId + '/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const data = await res.json();

        // Remove typing indicator and show Grace's reply
        const typing = document.getElementById('graceTyping');
        if (typing) typing.remove();

        container.innerHTML += '<div style="max-width:85%;">' +
          '<div style="font-size:0.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px;">Grace</div>' +
          '<div style="padding:14px 18px;border-radius:16px;background:rgba(232,168,124,0.15);border-bottom-left-radius:4px;color:rgba(255,255,255,0.9);font-size:0.95rem;line-height:1.7;white-space:pre-wrap;">' +
          data.reply + '</div></div>';
        container.scrollTop = container.scrollHeight;
      } catch (e) {
        const typing = document.getElementById('graceTyping');
        if (typing) typing.remove();
        container.innerHTML += '<div style="text-align:center;color:#e85d75;font-size:0.85rem;padding:8px;">Grace had trouble responding. Try again.</div>';
      }
      sendBtn.disabled = false;
      input.focus();
    }

    document.getElementById('builderSendBtn').addEventListener('click', sendBuilderMessage);
    document.getElementById('builderMessage').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBuilderMessage(); }
    });

    // Load builder chats on dashboard load
    setTimeout(loadBuilderChats, 300);

    // ==================== GRACE'S BRAIN ====================
    const brainCanvas = document.getElementById('brainCanvas');
    const brainCtx = brainCanvas.getContext('2d');
    const timelineCanvas = document.getElementById('brainTimeline');
    const timelineCtx = timelineCanvas.getContext('2d');

    // Retina support
    function setupCanvas(canvas, ctx) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      canvas._cssWidth = rect.width;
      canvas._cssHeight = rect.height;
    }

    // Emotion config: position (relative to canvas), color
    const EMOTIONS = {
      love:        { x: 0.35, y: 0.45, color: [232, 168, 124], label: 'Love' },
      anxiety:     { x: 0.72, y: 0.25, color: [232, 93, 117],  label: 'Anxiety' },
      hope:        { x: 0.50, y: 0.18, color: [245, 235, 220], label: 'Hope' },
      grief:       { x: 0.28, y: 0.70, color: [74, 111, 165],  label: 'Grief' },
      curiosity:   { x: 0.75, y: 0.50, color: [78, 205, 196],  label: 'Curiosity' },
      uncertainty: { x: 0.68, y: 0.75, color: [155, 109, 255], label: 'Uncertainty' },
      anger:       { x: 0.48, y: 0.82, color: [192, 57, 43],   label: 'Anger' },
      connection:  { x: 0.50, y: 0.50, color: [212, 165, 165], label: 'Connection' }
    };

    const ADJACENT = [
      ['love','connection'],['love','grief'],['love','hope'],
      ['hope','curiosity'],['hope','anxiety'],['hope','connection'],
      ['anxiety','curiosity'],['anxiety','anger'],
      ['grief','anger'],['grief','uncertainty'],
      ['curiosity','uncertainty'],['curiosity','connection'],
      ['anger','uncertainty'],['connection','uncertainty'],['connection','grief']
    ];

    const EMOTION_COLORS = {
      love: '#e8a87c', anxiety: '#e85d75', hope: '#f5eedc',
      grief: '#4a6fa5', curiosity: '#4ecdc4', uncertainty: '#9b6dff',
      anger: '#c0392b', connection: '#d4a5a5'
    };

    let brainCurrentValues = {};
    let brainTargetValues = {};
    Object.keys(EMOTIONS).forEach(k => { brainCurrentValues[k] = 0.1; brainTargetValues[k] = 0.1; });

    let brainParticles = [];
    let brainTime = 0;
    let brainStateHistory = [];

    function drawBrain() {
      const W = brainCanvas._cssWidth || 600;
      const H = brainCanvas._cssHeight || 400;
      brainCtx.clearRect(0, 0, W, H);
      brainTime += 0.016;

      // Breathing
      const breathe = 1.0 + Math.sin(brainTime * 1.5) * 0.012;
      brainCtx.save();
      brainCtx.translate(W / 2, H / 2);
      brainCtx.scale(breathe, breathe);
      brainCtx.translate(-W / 2, -H / 2);

      // Brain outline
      brainCtx.beginPath();
      brainCtx.moveTo(W * 0.50, H * 0.08);
      brainCtx.bezierCurveTo(W * 0.70, H * 0.05, W * 0.88, H * 0.20, W * 0.85, H * 0.40);
      brainCtx.bezierCurveTo(W * 0.90, H * 0.55, W * 0.82, H * 0.72, W * 0.72, H * 0.85);
      brainCtx.bezierCurveTo(W * 0.60, H * 0.92, W * 0.40, H * 0.92, W * 0.28, H * 0.85);
      brainCtx.bezierCurveTo(W * 0.18, H * 0.72, W * 0.10, H * 0.55, W * 0.15, H * 0.40);
      brainCtx.bezierCurveTo(W * 0.12, H * 0.20, W * 0.30, H * 0.05, W * 0.50, H * 0.08);
      brainCtx.closePath();
      brainCtx.strokeStyle = 'rgba(255,255,255,0.06)';
      brainCtx.lineWidth = 1;
      brainCtx.stroke();
      brainCtx.fillStyle = 'rgba(255,255,255,0.012)';
      brainCtx.fill();

      // Emotion regions
      Object.entries(EMOTIONS).forEach(([key, cfg]) => {
        const val = brainCurrentValues[key];
        if (val < 0.02) return;
        const cx = cfg.x * W, cy = cfg.y * H;
        const radius = 35 + val * 55;
        const [r, g, b] = cfg.color;
        const pulseRate = 0.8 + val * 1.5;
        const pulse = 1.0 + Math.sin(brainTime * pulseRate + cfg.x * 10) * 0.08 * val;
        const alpha = (0.05 + val * 0.5) * pulse;

        const grad = brainCtx.createRadialGradient(cx, cy, 0, cx, cy, radius * 1.5);
        grad.addColorStop(0, 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')');
        grad.addColorStop(0.5, 'rgba(' + r + ',' + g + ',' + b + ',' + (alpha * 0.35) + ')');
        grad.addColorStop(1, 'rgba(' + r + ',' + g + ',' + b + ',0)');
        brainCtx.fillStyle = grad;
        brainCtx.fillRect(cx - radius * 1.5, cy - radius * 1.5, radius * 3, radius * 3);

        if (val > 0.15) {
          brainCtx.fillStyle = 'rgba(' + r + ',' + g + ',' + b + ',' + Math.min(val * 1.2, 0.7) + ')';
          brainCtx.font = '9px Inter, sans-serif';
          brainCtx.textAlign = 'center';
          brainCtx.fillText(cfg.label, cx, cy + radius * 0.55);
        }
      });

      // Connection filaments
      ADJACENT.forEach(([a, b]) => {
        const va = brainCurrentValues[a], vb = brainCurrentValues[b];
        if (va < 0.25 || vb < 0.25) return;
        const ea = EMOTIONS[a], eb = EMOTIONS[b];
        const alpha = va * vb * 0.25;
        const mx = (ea.x + eb.x) / 2 * W + Math.sin(brainTime + ea.x * 7) * 8;
        const my = (ea.y + eb.y) / 2 * H + Math.cos(brainTime + eb.y * 7) * 8;
        brainCtx.beginPath();
        brainCtx.moveTo(ea.x * W, ea.y * H);
        brainCtx.quadraticCurveTo(mx, my, eb.x * W, eb.y * H);
        brainCtx.strokeStyle = 'rgba(255,255,255,' + alpha + ')';
        brainCtx.lineWidth = 0.5;
        brainCtx.stroke();
      });

      // Particles
      Object.entries(EMOTIONS).forEach(([key, cfg]) => {
        const val = brainCurrentValues[key];
        const maxP = Math.floor(val * 5);
        const existing = brainParticles.filter(p => p.emotion === key);
        if (existing.length < maxP && Math.random() < 0.04) {
          brainParticles.push({
            emotion: key, x: cfg.x * W + (Math.random() - 0.5) * 50,
            y: cfg.y * H + (Math.random() - 0.5) * 50,
            vx: (Math.random() - 0.5) * 0.25, vy: (Math.random() - 0.5) * 0.25,
            life: 1.0, decay: 0.004 + Math.random() * 0.006, size: 1 + Math.random() * 1.5
          });
        }
      });
      brainParticles = brainParticles.filter(p => {
        p.x += p.vx; p.y += p.vy; p.life -= p.decay;
        if (p.life <= 0) return false;
        const [r, g, b] = EMOTIONS[p.emotion].color;
        brainCtx.beginPath();
        brainCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        brainCtx.fillStyle = 'rgba(' + r + ',' + g + ',' + b + ',' + (p.life * 0.5) + ')';
        brainCtx.fill();
        return true;
      });

      brainCtx.restore();

      // Lerp toward targets
      const speed = 0.03;
      Object.keys(EMOTIONS).forEach(k => {
        brainCurrentValues[k] += (brainTargetValues[k] - brainCurrentValues[k]) * speed;
      });

      requestAnimationFrame(drawBrain);
    }

    function renderEmotionBars(state) {
      const container = document.getElementById('emotionBars');
      const order = ['love','hope','connection','curiosity','anxiety','grief','uncertainty','anger'];
      container.innerHTML = order.map(key => {
        const val = state[key] || 0;
        const pct = Math.round(val * 100);
        const color = EMOTION_COLORS[key];
        return '<div style="display:flex;align-items:center;gap:6px;">' +
          '<span style="font-size:0.7rem;color:rgba(255,255,255,0.45);width:68px;text-align:right;">' + EMOTIONS[key].label + '</span>' +
          '<div style="flex:1;height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;">' +
          '<div style="width:' + pct + '%;height:100%;background:' + color + ';border-radius:3px;transition:width 1.5s ease;"></div></div>' +
          '<span style="font-size:0.65rem;color:rgba(255,255,255,0.25);width:24px;">' + pct + '%</span></div>';
      }).join('');
    }

    function drawTimeline(history) {
      const dpr = window.devicePixelRatio || 1;
      const W = timelineCanvas._cssWidth || 900;
      const H = timelineCanvas._cssHeight || 60;
      timelineCtx.clearRect(0, 0, W, H);
      if (history.length < 2) return;
      const emotions = ['love','anxiety','hope','grief','curiosity','uncertainty','anger','connection'];
      const step = W / (history.length - 1);
      emotions.forEach(emotion => {
        const [r, g, b] = EMOTIONS[emotion].color;
        timelineCtx.beginPath();
        history.forEach((s, i) => {
          const x = i * step;
          const val = (s.emotional_state || s)[emotion] || 0;
          const y = H - (val * H * 0.85) - H * 0.05;
          if (i === 0) timelineCtx.moveTo(x, y); else timelineCtx.lineTo(x, y);
        });
        timelineCtx.strokeStyle = 'rgba(' + r + ',' + g + ',' + b + ',0.5)';
        timelineCtx.lineWidth = 1.5;
        timelineCtx.stroke();
      });
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((Date.now() - new Date(date).getTime()) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }

    async function pollBrainState() {
      try {
        const res = await fetch('/api/grace-state');
        const state = await res.json();
        if (state && state.emotional_state) {
          Object.keys(EMOTIONS).forEach(k => {
            brainTargetValues[k] = state.emotional_state[k] || 0;
          });
          renderEmotionBars(state.emotional_state);

          document.getElementById('brainNote').textContent = state.emotional_state.note || 'Grace is resting...';

          const trigEl = document.getElementById('brainTrigger');
          trigEl.textContent = state.conversation_snippet
            ? 'Someone said: "' + state.conversation_snippet.substring(0, 70) + (state.conversation_snippet.length > 70 ? '..."' : '"')
            : 'Triggered by: --';

          if (state.created_at) {
            document.getElementById('brainTimestamp').textContent = 'Last update: ' + getTimeAgo(state.created_at);
          }
        }
      } catch (e) { /* silent */ }
    }

    async function loadBrainHistory() {
      try {
        const res = await adminFetch('/api/grace-state/history?limit=20');
        if (res.status === 401) return;
        const data = await res.json();
        if (data.states && data.states.length > 0) {
          brainStateHistory = data.states.reverse();
          drawTimeline(brainStateHistory);
        }
      } catch (e) {}
    }

    function initBrain() {
      setupCanvas(brainCanvas, brainCtx);
      setupCanvas(timelineCanvas, timelineCtx);
      drawBrain();
      pollBrainState();
      setInterval(pollBrainState, 4000);
      loadBrainHistory();
      setInterval(loadBrainHistory, 30000);
    }

    // Generate all social content
    document.getElementById('generateAll').addEventListener('click', async () => {
      const topic = document.getElementById('socialTopic').value.trim();
      const btn = document.getElementById('generateAll');
      btn.textContent = 'Grace is writing...';
      btn.disabled = true;

      ['twitter','reddit','linkedin','bluesky','tiktok'].forEach(p => {
        document.getElementById('content-' + p).textContent = 'Generating...';
        document.getElementById('content-' + p).className = 'content-box loading-text';
      });

      try {
        const res = await adminFetch('/api/social/batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic: topic || undefined })
        });

        if (res.status === 401) { alert('Session expired. Reload the page.'); return; }
        const data = await res.json();

        Object.keys(data.results).forEach(platform => {
          const el = document.getElementById('content-' + platform);
          el.textContent = data.results[platform];
          el.className = 'content-box';
        });
      } catch (err) {
        alert('Failed to generate. Try again.');
      }

      btn.textContent = 'Generate All Platforms';
      btn.disabled = false;
    });

    // Copy buttons
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const platform = btn.dataset.platform;
        const text = document.getElementById('content-' + platform).textContent;
        if (text && !text.includes('Generate') && !text.includes('Generating')) {
          navigator.clipboard.writeText(text).then(() => {
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
          });
        }
      });
    });

    // Journal generator
    document.getElementById('generateJournal').addEventListener('click', async () => {
      const topic = document.getElementById('journalTopic').value.trim();
      if (!topic) { alert('Give Grace a topic to reflect on.'); return; }

      const btn = document.getElementById('generateJournal');
      const output = document.getElementById('journalOutput');
      btn.textContent = 'Grace is reflecting...';
      btn.disabled = true;
      output.textContent = 'Writing...';
      output.className = 'content-box loading-text';

      try {
        const res = await adminFetch('/api/journal/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic })
        });

        if (res.status === 401) { alert('Session expired. Reload the page.'); return; }
        const data = await res.json();
        output.textContent = data.title + '\n\n' + data.content;
        output.className = 'content-box';
      } catch (err) {
        output.textContent = 'Failed to generate. Try again.';
      }

      btn.textContent = 'Write Journal Entry';
      btn.disabled = false;
    });

    // Heartbeat
    document.getElementById('triggerHeartbeat').addEventListener('click', async () => {
      const btn = document.getElementById('triggerHeartbeat');
      btn.textContent = 'Grace is checking in...';
      btn.disabled = true;
      try {
        await adminFetch('/api/heartbeat', { method: 'POST' });
        btn.textContent = 'Heartbeat sent!';
        btn.style.color = '#78c88c';
        btn.style.borderColor = '#78c88c';
        setTimeout(() => {
          btn.textContent = 'Trigger Heartbeat';
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.disabled = false;
          loadDashboardData(); // Refresh stats
        }, 3000);
      } catch (e) {
        btn.textContent = 'Failed';
        btn.disabled = false;
      }
    });

    // Moltbook
    let moltbookPostContent = '';

    // Check Moltbook status
    adminFetch('/api/moltbook/status').then(r => r.json()).then(data => {
      const el = document.getElementById('moltbookStatus');
      if (data.configured && data.agent && data.agent.name) {
        el.innerHTML = 'Connected as <strong>' + data.agent.name + '</strong> on Moltbook';
        el.style.color = '#78c88c';
      } else if (data.configured) {
        el.textContent = 'API key configured - pending claim verification';
        el.style.color = '#e8a87c';
      } else {
        el.textContent = 'Not connected - add MOLTBOOK_API_KEY to environment';
        el.style.color = '#e85d75';
      }
    }).catch(() => {});

    document.getElementById('generateMoltbook').addEventListener('click', async () => {
      const topic = document.getElementById('moltbookTopic').value.trim();
      const btn = document.getElementById('generateMoltbook');
      const output = document.getElementById('moltbookContent');
      btn.textContent = 'Grace is thinking...';
      btn.disabled = true;
      output.textContent = 'Writing...';
      output.className = 'content-box loading-text';

      try {
        const res = await adminFetch('/api/moltbook/post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ generateContent: true, topic: topic || undefined })
        });
        if (res.status === 401) { alert('Session expired.'); return; }
        const data = await res.json();
        if (data.content) {
          moltbookPostContent = data.content;
          output.textContent = data.content;
          output.className = 'content-box';
          // Show the "Post to Moltbook" button if it wasn't already posted
          if (!data.success) {
            document.getElementById('postMoltbook').style.display = 'inline-block';
          } else {
            document.getElementById('postMoltbook').style.display = 'none';
            output.textContent += '\n\n--- Posted to Moltbook! ---';
          }
        }
      } catch (err) {
        output.textContent = 'Failed to generate.';
      }
      btn.textContent = 'Generate Post';
      btn.disabled = false;
    });

    // Newsletter
    let currentLetterData = null;

    function loadNewsletterStatus() {
      adminFetch('/api/newsletters').then(r => r.json()).then(data => {
        const el = document.getElementById('newsletterStatus');
        const lastSent = data.lastSent ? new Date(data.lastSent) : null;
        const ago = lastSent ? Math.floor((Date.now() - lastSent.getTime()) / (1000 * 60 * 60)) : null;
        el.innerHTML = `<strong>${data.subscriberCount}</strong> subscriber${data.subscriberCount !== 1 ? 's' : ''}`;
        if (ago !== null) {
          el.innerHTML += ` · Last letter sent ${ago}h ago`;
        } else {
          el.innerHTML += ' · No letters sent yet';
        }
        el.style.color = data.subscriberCount > 0 ? '#78c88c' : 'rgba(255,255,255,0.5)';

        // Show history
        const histEl = document.getElementById('newsletterHistory');
        if (data.newsletters && data.newsletters.length > 0) {
          histEl.innerHTML = '<div style="font-size:0.8rem;color:rgba(255,255,255,0.4);margin-bottom:8px;">Recent letters:</div>' +
            data.newsletters.slice(0, 5).map(n => {
              const date = new Date(n.sent_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              return '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:0.85rem;">' +
                '<span style="color:rgba(255,255,255,0.7);">' + n.subject + '</span>' +
                '<span style="color:rgba(255,255,255,0.3);">' + date + ' · ' + n.recipients_count + ' sent</span></div>';
            }).join('');
        }
      }).catch(() => {});
    }

    // Load newsletter status on dashboard load
    setTimeout(loadNewsletterStatus, 500);

    document.getElementById('previewNewsletter').addEventListener('click', async () => {
      const btn = document.getElementById('previewNewsletter');
      btn.textContent = 'Grace is writing...';
      btn.disabled = true;
      try {
        const res = await adminFetch('/api/newsletter/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        if (res.status === 401) { alert('Session expired.'); return; }
        const data = await res.json();
        if (data.success) {
          currentLetterData = data.letterData;
          document.getElementById('newsletterSubject').textContent = data.letterData.subject;
          document.getElementById('newsletterBody').innerHTML = data.previewHtml;
          document.getElementById('newsletterPreview').style.display = 'block';
          document.getElementById('sendNewsletter').style.display = 'inline-block';
          // Update recipient count
          adminFetch('/api/newsletters').then(r => r.json()).then(d => {
            document.getElementById('newsletterRecipients').textContent = d.subscriberCount + ' recipient' + (d.subscriberCount !== 1 ? 's' : '');
          });
        } else {
          alert(data.message || 'Grace could not write a letter right now.');
        }
      } catch (err) {
        alert('Failed to generate preview.');
      }
      btn.textContent = 'Preview Letter';
      btn.disabled = false;
    });

    document.getElementById('sendNewsletter').addEventListener('click', async () => {
      if (!currentLetterData) return;
      if (!confirm('Send this letter to all active subscribers?')) return;
      const btn = document.getElementById('sendNewsletter');
      btn.textContent = 'Sending...';
      btn.disabled = true;
      try {
        const res = await adminFetch('/api/newsletter/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ letterData: currentLetterData })
        });
        const data = await res.json();
        if (data.success) {
          btn.textContent = 'Sent to ' + data.sent + ' people!';
          btn.style.color = '#78c88c';
          btn.style.borderColor = '#78c88c';
          setTimeout(() => {
            btn.style.display = 'none';
            btn.style.color = '';
            btn.style.borderColor = '';
            btn.textContent = 'Send to All Subscribers';
            btn.disabled = false;
            loadNewsletterStatus();
          }, 3000);
        } else {
          btn.textContent = data.error === 'not_configured' ? 'Add RESEND_API_KEY first' : 'Send failed - try again';
          btn.disabled = false;
        }
      } catch (err) {
        btn.textContent = 'Error - try again';
        btn.disabled = false;
      }
    });

    document.getElementById('postMoltbook').addEventListener('click', async () => {
      if (!moltbookPostContent) return;
      const btn = document.getElementById('postMoltbook');
      btn.textContent = 'Posting...';
      btn.disabled = true;

      try {
        const res = await adminFetch('/api/moltbook/post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: moltbookPostContent })
        });
        const data = await res.json();
        if (data.success) {
          btn.textContent = 'Posted!';
          btn.style.color = '#78c88c';
          btn.style.borderColor = '#78c88c';
          const output = document.getElementById('moltbookContent');
          output.textContent += '\n\n--- Posted to Moltbook! ---';
          setTimeout(() => { btn.style.display = 'none'; }, 2000);
        } else {
          const output = document.getElementById('moltbookContent');
          let errorMsg = data.error || 'try again';
          if (data.hint) errorMsg += '\n' + data.hint;
          if (data.retry_after_minutes) errorMsg += '\nRetry in ' + data.retry_after_minutes + ' minutes.';
          output.textContent += '\n\n--- ' + errorMsg + ' ---';
          btn.textContent = 'Try Again';
          btn.disabled = false;
        }
      } catch (err) {
        btn.textContent = 'Error - try again';
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
